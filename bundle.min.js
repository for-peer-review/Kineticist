function Ellipse(e=0,t=0,s=1,i=1,n=0,a=2*Math.PI,r=!1,o=0){THREE.Curve.call(this),this.is2D=!0,this.closed=!0,this.aX=e,this.aY=t,this.xRadius=s,this.yRadius=i,this.aStartAngle=n/180*2*Math.PI,this.aEndAngle=a/180*2*Math.PI,this.aClockwise=r,this.aRotation=o/180*2*Math.PI}function Heart(e=5){THREE.Curve.call(this),this.is2D=!0,this.closed=!0,this.scale=e}function Sin(e=1,t=1,s=0,i=0,n=2*Math.PI){THREE.Curve.call(this),this.is2D=!0,this.closed=!1,this.a=e,this.f=t,this.p=s,this.t1=i,this.t2=n}function Spiral(e=1,t=0,s=0,i=1){THREE.Curve.call(this),this.is2D=0==s,this.closed=!1,this.r=e,this.dr=t,this.da=s,this.n=i}function TorusKnot(e,t,s,i){THREE.Curve.call(this),this.is2D=!1,this.closed=!0,this.r=e||5,this.tr=t||2,this.p=s||2,this.q=i||3}function DecoratedTorusKnot(e,t,s,i,n,a,r){THREE.Curve.call(this),this.is2D=!1,this.closed=!0,this.params=[e,t,s,i,n,a,r]}function GrannyKnot(){THREE.Curve.call(this),this.is2D=!1,this.closed=!0}function JunctionHelper(e="Rod",t=1){THREE.Object3D.call(this);let s=new THREE.BufferGeometry;s.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.line=new THREE.Line(s,junctionHelperMaterials[e]),this.line.matrixAutoUpdate=!1,this.line.layers.set(3),this.add(this.line),this.setLength(t)}function Junction(e="Rod",t=Math.PI/4,s=1,i=0,n=.1,a=36){THREE.Object3D.call(this),this.type=e,this.rSleeve=n,this.seg=a,this.theta=t,this.height=s,this.phase=i,this.envelope=null,this.skeleton=null,this.mechanism=null,this.initialize()}function KineticSculpture(e=null,t=[]){THREE.Object3D.call(this),this.axis=e,this.reference=null,this.contours=[],this.sketches=t,this.unit=null,this.units=new THREE.Group,this.add(this.units),this.outlines=new THREE.Group,this.add(this.outlines),this.axisWidth=.11,this.axle=null}function Rib(e){THREE.Object3D.call(this),this.type="Rib",this.endContainer=new THREE.Group,this.point1Container=new THREE.Group,this.point2Container=new THREE.Group,this.curveContainer=new THREE.Group,this.markerContainer=new THREE.Group,this.add(this.endContainer,this.point1Container,this.point2Container,this.curveContainer,this.markerContainer),e&&this.setEnd(e),this.start=new THREE.Vector3,this.endPosition=null,this.p1=null,this.p2=null,this.curve=null,this.sweepSteps=32,this.sectionShape="ellipse",this.sectionShapeParams={a:.2,b:.2},this.widthControls=[[0,1],[1,1]],this.thicknessControls=[[0,1],[1,1]],this.twistControls=[[0,0],[1,0]],this.widths=[],this.thicknesses=[],this.twists=[],this.translated=!1,this.skeleton=!1,this.curveMaterial=new THREE.LineBasicMaterial({color:255})}function Marker(e=1,t=1,s="plate"){THREE.Object3D.call(this),this.pos=e,this.sca=t,this.shape=s,this.pt=new THREE.Sprite(markerMaterial),this.pt.layers.set(1),this.pt.scale.set(.6,.6,.6),this.add(this.pt)}function Sketch(e="line",t=[],s,i="sketch",n=!1){THREE.Object3D.call(this),this.type="Sketch",this.name=e,this.role=i,this.timeOrder=0,this.closed=n,this.selected=!1,this.pointSize=1,this.width=1.5,this.curveResolution=50,"gl"==lineMode?this.material=new THREE.LineBasicMaterial({linewidth:this.width,color:lineColors[i]}):"tube"==lineMode&&(this.material=new THREE.MeshBasicMaterial({color:lineColors[i]})),this.parameters=s,this.keyPoints=t,this.curve=null,this.densePoints=[],this.denseLines=[],this.samplingPoints=[],this.samplingTangents=[],this.samplingNormalPlanes=[],this.pointMeshes=[],this.curveMesh=null,(this.parameters||this.keyPoints.length)&&this.buildMesh()}function Unit(e="propeller"){THREE.Object3D.call(this),this.type="Unit",this.isEmpty=!1,this.metaRotation=new THREE.Euler,this.currentMaterial=grayMaterial,this.shape=e,this.userData={morphTrans:{bias:[0,0,0],rotation:[0,0,0],size:[1,1,1]},sleeve:{rOut:1,rInner:.5,thickness:.5},velocity:.01},this.skeleton=new THREE.Group,this.add(this.skeleton),this.templeSkeleton=new THREE.Group,this.add(this.templeSkeleton),this.sleeve=null,this.bearing=null,this.sleeveRing=null,this.rod=null,this.fork=null,this.blades=new THREE.Group,this.blades.name="blades",this.add(this.blades),this.accessories=new THREE.Group,this.accessories.name="accessories",this.add(this.accessories),this.polygon=null}function convert2V3Array(e,t){for(var s=0;s<e.length;s++)e[[s]]=new THREE.Vector3(e[s].x,e[s].y,t)}function getRotationMatrixOnAxis(e,t,s){let i=e.x,n=e.y,a=e.z,r=t.x,o=t.y,l=t.z,h=r*r,c=r*o,u=r*l,d=o*o,p=o*l,m=l*l,f=i*r,g=i*o,w=i*l,v=n*r,y=n*o,M=n*l,b=a*r,E=a*o,x=a*l,R=Math.cos(s),T=Math.sin(s),C=h+(d+m)*R,k=c*(1-R)+l*T,I=u*(1-R)-o*T,S=0,P=c*(1-R)-l*T,H=d+(h+m)*R,U=p*(1-R)+r*T,D=0,V=u*(1-R)+o*T,O=p*(1-R)-r*T,L=m+(h+d)*R,A=0,j=(i*(d+m)-r*(y+x))*(1-R)+(M-E)*T,B=(n*(h+m)-o*(f+x))*(1-R)+(b-w)*T,z=(a*(h+d)-l*(f+y))*(1-R)+(g-v)*T,G=1;return(new THREE.Matrix4).set(C,k,I,S,P,H,U,D,V,O,L,A,j,B,z,G)}function perpendicularDistance(e,t,s){var i=t.y-e.y,n=e.x-t.x,a=t.x*e.y-e.x*t.y;return Math.abs(i*s.x+n*s.y+a/Math.sqrt(i*i+n*n))}function simplifyALine(e){for(let t=0;t<e.length-3;t++)(new THREE.Vector3).subVectors(e[t+1],e[t]),(new THREE.Vector3).subVectors(e[t+2],e[t+1])}function simplifyPoly(e,t){}function simplifyDP(e,t){for(var s=0,i=0,n=null,a=1;a<=e.length-2;a++){var r=perpendicularDistance(e[0],e[e.length-1],e[a]);r>s&&(i=a,s=r)}if(s>t){var o=simplifyDP(e.slice(0,i),t),l=simplifyDP(e.slice(i,e.length),t);n=o.concat(l)}else n=e.length>1?[e[0],e[e.length-1]]:[e[0]];return n}function computeCurvature(e,t){if(!e||t>1)return;let s=e.getTangent(t),i=e.getPoint(t),n=1==t?t-1e-6:t+1e-6,a=e.getTangent(n),r=e.getPoint(n);return Math.abs(s.angleTo(a)/i.distanceTo(r))}function computeCurvatureRadius(e,t){return 1/computeCurvature(e,t)}function getCurvatureData(e,t){let s=1e10,i=0;for(let n=.01;n<.99;n+=1/t){let t=computeCurvatureRadius(e,n);s=t<s?t:s,i=t>i?t:i}return{curvature:{min:1/i,max:1/s},radius:{min:s,max:i}}}function generatrixIntersection(e,t,s,i,n){let a=e.localToWorld(e.geometry.vertices[n].clone()),r=e.localToWorld(e.geometry.vertices[i+n].clone()),o=r.distanceTo(a),l=(new THREE.Vector3).subVectors(r,a).normalize(),h=new THREE.Raycaster(a,l,0,o*s);return 0!=h.intersectObject(t,!0).length}function sample(e,t,s){let i=[],n=t-e;for(let t=0;t<s;t++)i.push(e+Math.random()*n);return i}function pointsToPlane(e=[],t=new THREE.Plane,s=new THREE.Vector3(0,0,1)){let i=[];for(let n of e){let e=new THREE.Vector3,a=n.clone().add(s.clone().multiplyScalar(100)),r=n.clone().add(s.clone().multiplyScalar(-100)),o=new THREE.Line3(a,r);t.intersectLine(o,e)&&i.push(e)}return!(i.length<e.length)&&i}function buildAccessoryGeometry(e){switch(parseInt(e)){case 0:return new THREE.CylinderGeometry(1,1,.1,16);case 1:return new THREE.SphereGeometry(1,16,16);case 2:return bowlGeometry.clone();case 3:return ringGeometry.clone();case 4:return leafGeometry.clone()}}function save(e,t){link.href=URL.createObjectURL(e),link.download=t,link.click()}function saveString(e,t){save(new Blob([e],{type:"text/plain"}),t)}function loadCubeMap(e){cubemapLoader.setPath("cubemaps/"+e+"/");var t=cubemapLoader.load(["px.jpg","nx.jpg","py.jpg","ny.jpg","pz.jpg","nz.jpg"]);return t.name=e,t}function getLabeledMaterial(e){switch(e){case"T":labeledMaterial.color.setHex(8912896);break;case"S":labeledMaterial.color.setHex(136);break;case"R":labeledMaterial.color.setHex(34816)}}var Bottombar=function(e){signals=e.signals;var t=(new UI.Panel).setId("bottombar"),s=new UI.Text("TODO").setMarginLeft("10px");return t.add(s),signals.infoChanged.add(function(e){s.setValue(e)}),t},curveMap={Ellipse:function(e){return new Ellipse(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7])},Heart:function(e){return new Heart(e[0])},Sin:function(e){return new Sin(e[0],e[1],e[2],e[3],e[4])},Spiral:function(e){return new Spiral(e[0],e[1],e[2],e[3])},TorusKnot:function(e){return new TorusKnot(e[0],e[1],e[2],e[3])},DecoratedTorusKnot:function(e){return new DecoratedTorusKnot(e[0],e[1],e[2],e[3],e[4],e[5],e[6])},GrannyKnot:function(e){return new GrannyKnot(e[0])}};Ellipse.prototype=Object.assign(Object.create(THREE.Curve.prototype),{constructor:Ellipse,getPoint:function(e,t){for(var s=t||new THREE.Vector3,i=2*Math.PI,n=this.aEndAngle-this.aStartAngle,a=Math.abs(n)<Number.EPSILON;n<0;)n+=i;for(;n>i;)n-=i;n<Number.EPSILON&&(n=a?0:i),!0!==this.aClockwise||a||(n===i?n=-i:n-=i);var r=this.aStartAngle+e*n,o=this.aX+this.xRadius*Math.cos(r),l=this.aY+this.yRadius*Math.sin(r);if(0!==this.aRotation){var h=Math.cos(this.aRotation),c=Math.sin(this.aRotation),u=o-this.aX,d=l-this.aY;o=u*h-d*c+this.aX,l=u*c+d*h+this.aY}return s.set(o,l,0)},toJSON:function(){}}),Heart.prototype=Object.assign(Object.create(THREE.Curve.prototype),{constructor:Heart,getPoint:function(e,t){var s=t||new THREE.Vector3;e*=2*Math.PI;var i=16*Math.pow(Math.sin(e),3),n=13*Math.cos(e)-5*Math.cos(2*e)-2*Math.cos(3*e)-Math.cos(4*e),a=0;return s.set(i,n,a).multiplyScalar(this.scale)}}),Sin.prototype=Object.assign(Object.create(THREE.Curve.prototype),{constructor:Sin,getPoint:function(e,t){var s=t||new THREE.Vector3;e=e*(this.t2-this.t1)/180*Math.PI+this.t1/180*Math.PI;var i=this.a*Math.sin(e*this.f+this.p/180*Math.PI),n=0;return s.set(e,i,n)}}),Spiral.prototype=Object.assign(Object.create(THREE.Curve.prototype),{constructor:Spiral,getPoint:function(e,t){var s=t||new THREE.Vector3,i=2*Math.PI*e*this.n,n=Math.cos(i)*this.r+i*Math.cos(i)*this.dr,a=Math.sin(i)*this.r+i*Math.sin(i)*this.dr,r=this.da*i;return s.set(n,a,r)}}),TorusKnot.prototype=Object.assign(Object.create(THREE.Curve.prototype),{constructor:TorusKnot,getPoint:function(e,t){var s=t||new THREE.Vector3;e*=2*Math.PI;var i=(this.r+this.tr*Math.cos(this.q*e))*Math.cos(this.p*e),n=(this.r+this.tr*Math.cos(this.q*e))*Math.sin(this.p*e),a=this.tr*Math.sin(this.q*e);return s.set(i,n,a)}}),DecoratedTorusKnot.prototype=Object.assign(Object.create(THREE.Curve.prototype),{constructor:DecoratedTorusKnot,getPoint:function(e,t){var s=t||new THREE.Vector3;e*=2*Math.PI;var i=Math.cos(this.params[0]*e)*(1+this.params[1]*(Math.cos(this.params[2]*e)+this.params[3]*Math.cos(this.params[4]*e))),n=Math.sin(this.params[0]*e)*(1+this.params[1]*(Math.cos(this.params[2]*e)+this.params[3]*Math.cos(this.params[4]*e))),a=this.params[5]*Math.sin(this.params[6]*e);return s.set(i,n,a).multiplyScalar(4)}}),GrannyKnot.prototype=Object.assign(Object.create(THREE.Curve.prototype),{constructor:GrannyKnot,getPoint:function(e,t){var s=t||new THREE.Vector3;e=2*Math.PI*e;var i=-.22*Math.cos(e)-1.28*Math.sin(e)-.44*Math.cos(3*e)-.78*Math.sin(3*e),n=-.1*Math.cos(2*e)-.27*Math.sin(2*e)+.38*Math.cos(4*e)+.46*Math.sin(4*e),a=.7*Math.cos(3*e)-.4*Math.sin(3*e);return s.set(i,n,a)}});var surfaceMap={};JunctionHelper.prototype=Object.create(THREE.Object3D.prototype),JunctionHelper.prototype.constructor=JunctionHelper,JunctionHelper.prototype.dispose=function(){this.line.geometry.dispose()},JunctionHelper.prototype.setLength=function(e){this.line.scale.set(1,1,e),this.line.updateMatrix()},JunctionHelper.prototype.copy=function(e){return THREE.Object3D.prototype.copy.call(this,e,!1),this.line.copy(e.line),this},JunctionHelper.prototype.clone=function(){return(new this.constructor).copy(this)},Junction.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:Junction,clone:function(){let e=new Junction(this.type,this.theta,this.h,this.phase,this.rSleeve,this.seg);return this.skeleton&&(e.skeleton=this.skeleton.clone(),e.skeleton.applyMatrix(this.skeleton.matrix),e.add(e.skeleton)),this.mechanism&&(e.mechanism=this.mechanism.clone(),e.mechanism.applyMatrix(this.mechanism.matrix),e.add(e.mechanism)),e.applyMatrix(this.matrix),e},dispose:function(){this.envelope&&(this.remove(this.envelope),this.envelope.geometry.dispose()),this.clear()},clear:function(){this.skelelton&&(this.remove(this.skelelton),this.skelelton.traverse(function(e){e.geometry&&e.geometry.dispose()})),this.mechanism&&(this.remove(this.mechanism),this.mechanism.traverse(function(e){e.geometry&&e.geometry.dispose()})),this.plug&&this.plug.geometry&&this.plug.geometry.dispose()},initialize:function(){this.buildEnvelope(this.theta,this.height)},buildEnvelope:function(e=Math.PI/3,t=1){this.clearEnvelope(),this.theta=e,this.height=t;let s=t*Math.tan(e)+this.rSleeve,i=new THREE.CylinderGeometry(this.rSleeve,s,t,this.seg,1,!0);"Rod"==this.type?(this.envelope=new THREE.Mesh(i,rodFrustumMaterial),this.envelope.rotation.set(-Math.PI/2,0,0),this.envelope.position.set(0,0,this.height/2)):"Fork"==this.type&&(this.envelope=new THREE.Mesh(i,forkFrustumMaterial),this.envelope.rotation.set(Math.PI/2,0,0),this.envelope.position.set(0,0,-this.height/2)),this.envelope.layers.set(5),this.add(this.envelope),this.envelope.updateMatrixWorld()},clearEnvelope:function(){this.envelope&&(this.remove(this.envelope),this.envelope.geometry.dispose(),this.envelope=null)},buildSkeleton:function(){this.skeleton&&(this.skeleton.dispose(),this.remove(this.skeleton));let e=this.height/Math.cos(this.theta);this.skeleton=new JunctionHelper(this.type,e),this.skeleton.position.set(this.rSleeve,0,0),"Rod"==this.type?this.skeleton.rotateY(this.theta):"Fork"==this.type&&this.skeleton.rotateY(Math.PI-this.theta),this.rotation.set(0,0,this.phase),this.add(this.skeleton)},buildMechanism:function(){this.mechanism&&(this.mechanism.traverse(function(e){e.geometry&&e.geometry.dispose()}),this.remove(this.mechanism)),this.skeleton||this.buildSkeleton();let e=this.height/Math.cos(this.theta),t=.1*this.rSleeve,s=new THREE.CylinderBufferGeometry(t,t,e,32);if(s.rotateX(Math.PI/2),s.translate(0,0,e/2),"Rod"==this.type){let s=new THREE.CylinderBufferGeometry(t,t,e,8);s.rotateX(Math.PI/2),s.translate(0,0,e/2);let i=new THREE.Mesh(s,rodColoredMaterial);i.name="unit-rod",i.layers.set(4),this.add(i),i.position.copy(this.skeleton.position),i.rotation.copy(this.skeleton.rotation),this.mechanism=i,this.plug=i}else if("Fork"==this.type){let i=.3*e,n=new THREE.CylinderGeometry(t,t,i);n.translate(0,i/2,0);let a=new THREE.BoxGeometry(2*t,2*t,6*t);a.translate(0,i-t,0),n.merge(a);let r=new THREE.CylinderGeometry(t,t,.7*e),o=r.clone();r.translate(0,(e+i)/2,2.2*t),o.translate(0,(e+i)/2,-2.2*t),n.merge(r),n.merge(o);let l=new THREE.BufferGeometry;l.fromGeometry(n),l.rotateX(Math.PI/2);let h=new THREE.Mesh(l,forkColoredMaterial);h.name="unit-fork",h.layers.set(4),this.add(h),h.position.copy(this.skeleton.position),h.rotation.copy(this.skeleton.rotation),this.mechanism=h;let c=new THREE.Mesh(s.clone(),rodColoredMaterial);c.visible=!1,this.add(c),c.position.copy(this.skeleton.position),c.rotation.copy(this.skeleton.rotation),this.plug=c}},checkConnection:function(e){let t=this.envelope,s=e.envelope,i=t.geometry.vertices.length/2;for(let e=0;e<i;e++)if(!generatrixIntersection(t,s,.95,i,e))return!1;return!0},toJSON:function(){return{type:this.type,theta:this.theta,height:this.height,phase:this.phase,rSleeve:this.rSleeve,seg:this.seg}},fromJSON:function(e){this.dispose(),this.type=e.type,this.theta=e.theta,this.phase=phase,this.rSleeve=rSleeve,this.seg=seg,this.initialize(),this.buildSkeleton(),this.buildMechanism()}}),KineticSculpture.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:KineticSculpture,clone:function(){let e=this.axis.clone(),t=this.sketches.map(function(e){return e.clone()}),s=new KineticSculpture(e,t);s.unit=this.unit.clone();for(let e of this.units.children)s.units.add(e.clone());for(let e of this.outlines.children)s.outline.add(e.clone());return s.axisWidth=this.axisWidth,s.buildAxle(),s},clear:function(){this.axle&&(this.axle.geometry.dispose(),this.remove(this.axle));for(let e of this.outlines.children)e.dispose(),this.outlines.remove(e);this.outlines.children=[];for(let e of this.units.children)e.dispose();this.units.children=[]},setAxis:function(e){e instanceof Sketch?(e.setRole("axis"),this.axis=e):this.axis=null},addContour:function(e){this.sketches.indexOf(e)<0&&this.sketches.push(e),e instanceof Sketch&&(e.deselect(),e.setRole("contour"))},removeContour:function(e){e instanceof Sketch&&(e.deselect(),e.setRole("sketch")),this.sketches.splice(this.sketches.indexOf(e),1)},clearContours:function(){for(let e of this.sketches)e instanceof Sketch&&(e.deselect(),e.setRole("sketch"));this.sketches=[]},layout:function(e,t,s=!1){this.params=t,this.unit=e,this.clear(),this.unit.resetTransform(),this.axis.sample(t.n);let i=this.axis.samplingPoints,n=null;this.reference?n=this.axis.getReferencedFrames(this.reference,t.n):0!=this.sketches.length&&1!=s||(n=this.axis.ff);for(let e=0;e<i.length;e++){if(!n.normals[e]){console.log("missing");continue}let s=this.unit.clone();s.idx=e;let a=(new THREE.Matrix4).makeBasis(n.normals[e],n.binormals[e],n.tangents[e]).multiplyScalar(t.scale).setPosition(i[e]);s.applyMatrix(a),s.updatePointSize(),0==this.sketches.length&&0!=t.torsion&&s.rotateZ(t.torsion/180*Math.PI*e),s.metaRotation=s.rotation.clone(),this.units.add(s),s.updateMatrixWorld()}},showTransmissionInMetaUnit:function(){this.unit.joints.children=[],this.unit.joints.add(this.units.children[1].joints.children[0].clone()),this.unit.joints.add(this.units.children[1].joints.children[1].clone())},computeOutlines:function(){this.units.children.length;for(let e of this.units.children);},buildOutlines:function(){this.clearOutlines();let e=this.units.children[0].skeleton.children.length;for(let t=0;t<e;t++){let e=[];for(let s=0;s<this.units.children.length;s++){let i=this.units.children[s].skeleton.children[t].end;e.push(i.localToWorld(new THREE.Vector3))}let s=new Sketch("spline",e,void 0,"sketch",this.axis.closed);s.pointMeshes.map(function(e){e.material.size=.3}),this.outlines.add(s)}},clearOutlines:function(){for(let e of this.outlines.children)e.dispose();this.outlines.children=[]},clearSkeleton:function(){for(let e of this.units.children)e.dispose();this.units.children=[]},setSleeveRadii:function(){this.axis.curveMesh.geometry.computeBoundingSphere();let e=this.axis.curveMesh.geometry.boundingSphere.radius*this.axis.curveMesh.scale.z;this.unit.userData.sleeve.rOut=e/25,this.unit.userData.sleeve.rInner=e/50,this.unit.userData.sleeve.thickness=e/50,this.axis.closed||(this.unit.userData.sleeve.rOut/=2,this.unit.userData.sleeve.rInner/=2,this.unit.userData.sleeve.thickness/=2)},buildSkeleton:function(e=1/0,t=20){this.clearSkeleton(),this.clear(),this.unit=new Unit;let s={n:t,scale:1,torsion:0};this.setSleeveRadii(),this.axis.sample(s.n),this.layout(this.unit,s,!0);let n=this.axis.getNormalIntersectionsWithCurves(this.sketches,e);for(i=0;i<t;i++){let e=n[i],t=this.units.children[i];if(0!=e.length){for(end of e){let e=end.clone();t.worldToLocal(e),t.addRib(e)}t.buildSleeveRing(),t.updatePointSize(.1)}else t.isEmpty=!0}},setController:function(){},testGroupedSpeed:function(e,t){for(let s=0;s<this.units.children.length;s++)this.units.children[s].userData.velocity=s%2==0?e:t},testVariedSpeed:function(){for(let e=0;e<this.units.children.length;e++){let t=this.units.children[e];t.userData.velocity=.01*Math.sin(e/5*Math.PI)+.02}let e=this;setInterval(function(){for(let t=0;t<e.units.children.length;t++){let s=e.units.children[t];s.userData.velocity=-s.userData.velocity}},2e3)},testVariedSpeed1:function(){this.clearSkeleton(),this.clear(),this.unit=new Unit;let e={n:20,scale:1,torsion:0};this.setSleeveRadii(),this.axis.sample(e.n),this.layout(this.unit,e,!0);let t=this.axis.getNormalIntersectionsWithCurves([this.sketches[0]],5),s=[];for(i=0;i<20;i++){let e=t[i],n=this.units.children[i];if(0==e.length){n.isEmpty=!0;continue}let a=[];for(let t=0;t<e.length-1;t++){let s=e[t].clone();a.push(e[t+1].angleTo(s)/60),0==t&&(n.worldToLocal(s),n.addRib(s)),t==e.length-2&&a.push(e[0].angleTo(e[t+1])/60)}s.push(a),n.buildSleeveRing(),n.updatePointSize(.1)}},simulateMotion:function(){for(unit of this.units.children)unit.rotateZ(unit.userData.velocity);this.outlines.children.length>0&&this.buildOutlines()},reset:function(){for(unit of this.units.children)unit.rotation.copy(unit.metaRotation),unit.updateMatrixWorld();this.outlines.children.length>0&&this.buildOutlines()},buildJoints:function(e=!1){for(let e of this.units.children)e.computeBestPhase();let t=!0;for(let s=0;s<this.units.children.length-1;s++){let i=this.units.children[s],n=this.units.children[s+1];if(i.isEmpty||n.isEmpty)continue;i.junctionPhase!=n.junctionPhase&&(i.junctionPhase=n.junctionPhase);let a=i.position.distanceTo(n.position)/i.scale.z,r=!1;for(let e=Math.PI/6;e<Math.PI/3;e+=Math.PI/180){for(let t=.6*a;t<.9*a;t+=.015*a)if(i.buildRod(e,t),n.buildFork(e,t),i.rod.checkConnection(n.fork)){i.rod.buildMechanism(),n.fork.buildMechanism(),this.params&&n.fork.rotateZ(-this.params.torsion/180*Math.PI),r=!0;break}if(r)break}if(!r){if(!e){t=!1;break}i.setMaterial(highlightUnitMaterial),n.setMaterial(highlightUnitMaterial),t=!1}}return t},buildAxle:function(){this.axle&&(this.axle.geometry.dispose(),this.remove(this.axle)),this.axle=new THREE.Mesh(new THREE.TubeBufferGeometry(this.axis.curve,100,this.axisWidth,8,this.axis.curve.autoClose),axleMaterial),this.axle.layers.set(4),this.add(this.axle)},buildBearings:function(){for(let e of this.units.children)e.buildBearing(this.axisWidth/e.scale.x)},getMechanisms:function(){let e=[];for(u of this.units.children){let t=u.getMechanisms();t.length>0&&e.push(...t)}return e},toJSON:function(){let e=this.axis?this.axis.uuid:null,t=[];for(let e of this.sketches)t.push(e.uuid);return{axisId:e,sketchIds:t,morphTrans:this.units.children.map(function(e){return e.userData.morphTrans}),params:this.params}},fromJSON:function(e){for(let t=0;t<this.units.children.length;t++){let s=this.units.children[t];for(let i in e.morphTrans[t]){let[n,a,r]=e.morphTrans[t][i];s[morphOpMap[i]](n,a,r)}s.blades.children.length>0&&s.generateShape()}this.buildJoints()}});var Leftbar=function(e){function t(e){switch(e){case"unit-scene":i.setDisplay(""),n.setDisplay("none"),s.setDisplay("none");break;case"sculpture-scene":i.setDisplay("none"),n.setDisplay(""),s.setDisplay("")}}signals=e.signals;var s=(new UI.Panel).setId("leftbar"),i=new Leftbar.Unit(e);s.add(i);var n=new Leftbar.Layout(e);return s.add(n),signals.sceneChanged.add(function(e){t(e)}),signals.objectSelected.add(function(t){"unit-scene"==e.currentScene.name&&(t instanceof Rib?s.setDisplay(""):s.setDisplay("none"))}),t(e.currentScene.name),s.setDisplay("none"),s};Leftbar=function(e){function t(e){switch(e){case"unit-scene":i.setDisplay(""),n.setDisplay("none"),s.setDisplay("none");break;case"sculpture-scene":i.setDisplay("none"),n.setDisplay(""),s.setDisplay("")}}signals=e.signals;var s=(new UI.Panel).setId("leftbar"),i=new Leftbar.Unit(e);s.add(i);var n=new Leftbar.Layout(e);return s.add(n),signals.sceneChanged.add(function(e){t(e)}),signals.objectSelected.add(function(t){"unit-scene"==e.currentScene.name&&(t instanceof Rib?s.setDisplay(""):s.setDisplay("none"))}),t(e.currentScene.name),s.setDisplay("none"),s};Leftbar.Unit=function(e){var t=e.signals,s=(new UI.Panel).setId("leftbar-unit"),i=(new UI.Panel).setClass("content");s.add(i);var n=new UI.Row;i.add(n);var a=new Leftbar.Unit.Semantic(e);n.add(a);var r=new Leftbar.Unit.Blade(e);i.add(r);var o=new Leftbar.Unit.Accessory(e);return i.add(o),t.objectSelected.add(function(e){e||(a.setDisplay("none"),r.setDisplay("none"),o.setDisplay("none")),e&&(e instanceof Rib?(a.setDisplay(""),r.setDisplay(""),o.setDisplay("")):(a.setDisplay("none"),r.setDisplay("none"),o.setDisplay("none")))}),s},Leftbar.Unit.Semantic=function(e){function t(){if(e.selectedObjects.length>0)for(let t of e.selectedObjects)t.setSep(r.getValue()),t.setBias(a.getValue()),t.setTangentArch(o.getValue()),t.setTangentWave(l.getValue()),t.setAxialArch(h.getValue()),t.setAxialWave(c.getValue());else{let t=e.selected;t.setSep(r.getValue()),t.setBias(a.getValue()),t.setTangentArch(o.getValue()),t.setTangentWave(l.getValue()),t.setAxialArch(h.getValue()),t.setAxialWave(c.getValue()),i.objectTransformed.dispatch(e.selected)}}function s(e){a.setValue(e.getBias()),r.setValue(e.getSep()),o.setValue(e.getTangentArch()),l.setValue(e.getTangentWave()),h.setValue(e.getAxialArch()),c.setValue(e.getAxialWave())}var i=e.signals,n=(new UI.Panel).setId("leftbar-unit-semantic").add(new UI.Text("semantics").setClass("sect-title"));n.setDisplay("none"),n.add(new UI.Text("◆ radial bias").setClass("param-semantics"));var a=new UI.Number(0).setRange(-1,1).onChange(t);n.add(a),n.add(new UI.Text("◆ radial sep").setClass("param-semantics"));var r=new UI.Number(0).setRange(0,1).onChange(t);n.add(r),n.add(new UI.Text("◆ tan bend").setClass("param-semantics"));var o=new UI.Number(0).setRange(-1,1).onChange(t);n.add(o),n.add(new UI.Text("◆ tan wave").setClass("param-semantics"));var l=new UI.Number(0).setRange(-1,1).onChange(t);n.add(l),n.add(new UI.Text("◆ axial bend").setClass("param-semantics"));var h=new UI.Number(0).setRange(-1,1).onChange(t);n.add(h),n.add(new UI.Text("◆ axial wave").setClass("param-semantics"));var c=new UI.Number(0).setRange(-1,1).onChange(t);return n.add(c),i.objectSelected.add(function(e){e&&(e instanceof Rib?(n.setDisplay(""),s(e)):n.setDisplay("none"))}),i.objectTransformed.add(function(e){if(e&&"ribpoint"==e.name){let t=e.parent.parent;s(t)}}),n},Leftbar.Unit.Blade=function(e){function t(){if(!n)if(e.selectedObjects.length>0)for(let t of e.selectedObjects)t.widthControls=r.getControls(),t.thicknessControls=o.getControls(),t.widths=r.getValues(t.sweepSteps),t.thicknesses=o.getValues(t.sweepSteps);else{let t=e.selected;t.widthControls=r.getControls(),t.thicknessControls=o.getControls(),t.widths=r.getValues(t.sweepSteps),t.thicknesses=o.getValues(t.sweepSteps)}}function s(e){n=!0,r.setControls(e.widthControls),o.setControls(e.thicknessControls),n=!1}var i=e.signals,n=!0,a=(new UI.Panel).setId("leftbar-unit-blade").add(new UI.HorizontalRule,new UI.Text("blade sweeping").setClass("sect-title"));a.setDisplay("none"),a.add(new UI.Text("◆ width").setClass("param-semantics"));var r=new UI.SplineController(1,8,!1,1,1).onDraw(t);a.add(r),a.add(new UI.Text("◆ thickness").setClass("param-semantics"));var o=new UI.SplineController(1,5,!1,1,1).onDraw(t);return a.add(o),i.objectSelected.add(function(e){e&&(e instanceof Rib?(a.setDisplay(""),s(e)):a.setDisplay("none"))}),a},Leftbar.Unit.Accessory=function(e){function t(){if(0===c.length)d.add(n(1,1,0));else{var t=c[c.length-1];d.add(n(t.t.getValue(),t.s.getValue(),t.shape.getValue()))}let[s,i,a]=[c[c.length-1].t.getValue(),c[c.length-1].s.getValue(),c[c.length-1].shape.getValue()];if(e.selectedObjects.length>0)for(let t of e.selectedObjects)t.addMarker(s,i,a);else{let t=e.selected;t instanceof Rib&&t.addMarker(s,i,a)}}function s(t,s,i,n){if(e.selectedObjects.length>0)for(let a of e.selectedObjects)a.updateMarker(t,s,i,n);else{let a=e.selected;a instanceof Rib&&a.updateMarker(t,s,i,n)}}function i(){let t=e.selected;if(t instanceof Rib){h=0,c=[],d.clear();for(let e of t.markerContainer.children)d.add(n(e.pos,e.sca,e.shape))}}function n(t,i,n){var r=h,l=(new UI.Div).setMarginBottom("2px"),u=new UI.Number(t).setRange(0,1).setWidth("30px").setMargin("0").onChange(function(){s(r,u.getValue(),d.getValue(),p.getValue())}),d=new UI.Number(i).setWidth("30px").setMargin("0").onChange(function(){s(r,u.getValue(),d.getValue(),p.getValue())}),p=(new UI.Select).setWidth("50px").setMarginRight("10px").onChange(function(){s(r,u.getValue(),d.getValue(),p.getValue())});p.setMultiple=!1,p.setOptions(o),p.setValue(n);var m=new UI.Button("-").setFontSize("8px").setWidth("20px").setHeight("20px").setMargin("0").setPadding("0").onClick(function(){if(e.selectedObjects.length>0)for(let t of e.selectedObjects)t.removeMarker(r);else{let t=e.selected;t instanceof Rib&&t.removeMarker(r)}a(r)});return m.dom.style.borderRadius="0",c.push({row:l,t:u,shape:p,s:d}),h++,l.add(u,d,p,m),l}function a(e){c[e]&&(d.remove(c[e].row),c[e]=null,i())}var r=e.signals,o=["plate","ball","bowl","ring","leaf"],l=(new UI.Panel).setId("leftbar-unit-accessory").add(new UI.HorizontalRule,new UI.Text("accessory").setClass("sect-title").setWidth("80px"));l.setDisplay("none");var h=0,c=[],u=(new UI.Span).setDisplay("inline-block"),d=(new UI.Div).setMarginLeft("10px");u.add(d);var p=(new UI.Button).setId("add-acc").setMarginLeft("10px").onClick(t);return p.dom.title="add an accessory marker",l.add(p),l.add(new UI.Text("pos◆scale◆shape").setClass("param")),l.add(u),r.objectSelected.add(function(e){e&&(e instanceof Rib?(l.setDisplay(""),i()):l.setDisplay("none"))}),l},Leftbar.Layout=function(e){function t(){let t={n:u.getValue(),scale:p.getValue(),torsion:f.getValue()};e.sculpture&&(e.layout(t),n.sculptureChanged.dispatch())}function s(){0!=e.sculpture.units.children.length?e.sculpture.buildJoints(!0)?n.infoChanged.dispatch("Got a feasible solution."):n.infoChanged.dispatch("Failed, please modify axis shape near highlighted units, or densify units"):alert("please layout first!")}function i(){let t=e.sculpture;for(let e of t.units.children)e.userData.decs.has=!0,e.userData.decs.positions=[1],e.userData.decs.scales=[.5],e.userData.decs.shapes=["0"],e.userData.blade.a=.05,e.userData.blade.b=.05,e.generateShape();t.buildAxle()}var n=e.signals,a=(new UI.Panel).setId("leftbar-layout").setDisplay("none"),r=(new UI.Button).setId("layout").onClick(t),o=(new UI.Button).setId("clear-layout").onClick(function(){e.sculpture.clear()}),l=(new UI.Panel).setWidth("100%").setHeight("43px").setMargin("0").setPadding("0").setBackground("#ddd");a.add(l),l.add(new UI.Text("Layout").setClass("bar-title").setWidth("70px"),r,o);var h=(new UI.Panel).setClass("content");a.add(h);var c=new UI.Row;h.add(c),c.add(new UI.Text("number").setClass("param-semantics"));var u=new UI.Integer(10).setRange(3,60);c.add(u);var d=new UI.Row;h.add(d),d.add(new UI.Text("scale").setClass("param-semantics"));var p=new UI.Number(1).setPrecision(2).setRange(.01,100);d.add(p);var m=new UI.Row;h.add(m),m.add(new UI.Text("torsion").setClass("param-semantics"));var f=new UI.Number(0).setPrecision(2).setRange(-100,100);m.add(f);var g=new Leftbar.Morphs(e);a.add(g);var w=(new UI.Panel).setClass("content"),v=(new UI.Button).setId("transmissions").onClick(s);a.add(new UI.Text("Mechanism").setClass("bar-title"),w.add(new UI.Text("solve transmissions").setClass("param").setWidth("90px").setMarginRight("20px"),v));let y=new UI.Number(20).setRange(5,20).setPrecision(.1).setMarginLeft("5px"),M=new UI.Button("refine models").setWidth("150px").onClick(function(){e.sculpture.axisWidth=y.getValue()/200,e.sculpture.buildAxle(),e.sculpture.buildBearings()});w.add(M);let b=new UI.Button("export stl").setWidth("150px").onClick(function(){let t=new THREE.Group;transMat=grayMaterial.clone(),transMat.transparent=!0,transMat.opacity=.5;let s=new THREE.MeshNormalMaterial;for(let i of e.sculpture.units.children){let e=new THREE.Group;t.add(e);let n=i.refineSleeve();if(n.material=s,e.add(n),i.fork){let t=i.fork.mechanism.clone();t.applyMatrix(i.fork.matrix),t.material=transMat,e.add(t)}if(i.rod){let t=i.rod.mechanism.clone();t.applyMatrix(i.rod.matrix),t.material=transMat,e.add(t)}e.applyMatrix(i.matrix),e.updateMatrixWorld()}var i=exporter.parse(t);saveString(i,"parts.stl")});w.add(b);new UI.Button("generate units").onClick(i);return n.unitScaleChanged.add(function(t){if(e.sculpture.params)return u.setValue(e.sculpture.params.n),p.setValue(e.sculpture.params.scale),void f.setValue(e.sculpture.params.torsion);let s=getCurvatureData(e.sculpture.axis.curve,200).radius.min*e.sculpture.axis.scale.x,i=e.unit.getMaxRadius()*e.unit.scale.x;if(0==i)p.setValue(1);else{let e=Math.min(.9*s/i,1);p.setValue(e)}}),a},Leftbar.Morphs=function(e){function t(t){e.select(null),e.showKeys=!1;for(let t in e.unitMorphKeys)for(let s of e.unitMorphKeys[t])s.setMaterial(e.currentMaterial);if(t!=e.currentMorph){e.showKeys=!0,getLabeledMaterial(t);for(let s of e.unitMorphKeys[u[t]])s.setMaterial(labeledMaterial)}s(t)}function s(t){if(e.currentMorph==t){for(let s of y)if(s.label==t)return e.currentMorph="",void s.setValue(!1)}else for(let s of y)s.label==t?(e.currentMorph=t,s.setValue(!0)):s.setValue(!1)}function i(t){x.setValue(t.userData.morphTrans.bias[0]),R.setValue(t.userData.morphTrans.bias[1]),
T.setValue(t.userData.morphTrans.bias[2]),"T"==e.currentMorph?biasValueRow.setDisplay(""):biasValueRow.setDisplay("none")}function n(t){C.setValue(t.userData.morphTrans.rotation[0]/Math.PI*180),I.setValue(t.userData.morphTrans.rotation[1]/Math.PI*180),S.setValue(t.userData.morphTrans.rotation[2]/Math.PI*180),"R"==e.currentMorph?rotationValueRow.setDisplay(""):rotationValueRow.setDisplay("none")}function a(t){P.setValue(t.userData.morphTrans.size[0]),H.setValue(t.userData.morphTrans.size[1]),"S"==e.currentMorph?sizeValueRow.setDisplay(""):sizeValueRow.setDisplay("none")}function r(t){e.selected instanceof Unit&&(e.unitMorphKeys[t].indexOf(e.selected)>=0||(e.unitMorphKeys[t].push(e.selected),h(e.unitMorphKeys[t]),e.selected.setMaterial(labeledMaterial),D[t](e.selected),c.setMorphControl.dispatch(t)))}function o(t){e.unitMorphKeys[t].indexOf(e.selected)>=0&&(e.selected.setMaterial(e.currentMaterial),e.unitMorphKeys[t].splice(e.unitMorphKeys[t].indexOf(e.selected),1),U[t].setDisplay("none"),e.selected.userData.morphTrans[t]=V[t],l(t),c.removeMorphControl.dispatch())}function l(){if(!(e.selected instanceof Unit))return;let t=null,s=u[e.currentMorph];switch(s){case"bias":t=[x.getValue(),R.getValue(),T.getValue()];break;case"rotation":t=[C.getValue()*Math.PI/180,I.getValue()*Math.PI/180,S.getValue()*Math.PI/180];break;case"size":t=[P.getValue(),H.getValue(),1]}e.selected.userData.morphTrans[s]=t;let i=e.unitMorphKeys[s].map(function(t){return e.sculpture.units.children.indexOf(t)});for(let t=0;t<e.sculpture.units.children.length;t++){let n=[];for(let a=0;a<3;a++){let r=e.unitMorphKeys[s].map(function(e){return e.userData.morphTrans[s][a]}),o=0==f.getValue(),l=o?new THREE.LinearInterpolant(i,r,1):new THREE.CubicInterpolant(i,r,1);n.push(l.evaluate(t)[0])}e.sculpture.units.children[t][morphOpMap[s]](n[0],n[1],n[2]),e.sculpture.units.children[t].generateShape()}}function h(e){e.sort(function(e,t){return e.idx<t.idx?-1:e.idx>t.idx?1:0})}var c=e.signals;let u={T:"bias",R:"rotation",S:"size"};var d=(new UI.Panel).setId("morphs").setMargin("0").setPadding("0");d.add(new UI.Text("Morph").setClass("bar-title"));var p=(new UI.Panel).setClass("content");d.add(p);let m=["linear","cubic"],f=(new UI.Select).setWidth("90px").setMarginLeft("10px");p.add(new UI.Text("Interpolation method").setClass("sect-title"),f),f.setOptions(m),f.setValue(0),p.add(new UI.Text("Morph mode").setClass("sect-title"));let g=new UI.Radio(!1,"T"),w=new UI.Radio(!1,"R"),v=new UI.Radio(!1,"S"),y=[g,w,v];p.add((new UI.Row).add(g,new UI.Text("translation morph").setClass("param").setColor("red")).onClick(function(){t("T")}),(new UI.Row).add(w,new UI.Text("rotation morph").setClass("param").setColor("green")).onClick(function(){t("R")}),(new UI.Row).add(v,new UI.Text("scale morph").setClass("param").setColor("blue")).onClick(function(){t("S")}));var M=(new UI.Panel).setClass("content").setDisplay("none");p.add(M);var b=new UI.Row;M.add(b);let E=(new UI.Checkbox).onChange(function(){E.getValue()?r(u[e.currentMorph]):o(u[e.currentMorph])});b.add(new UI.Text("set as control").setClass("param"),E),biasValueRow=(new UI.Row).setDisplay("none"),M.add(biasValueRow);var x=(new UI.Number).onChange(l);biasValueRow.add(new UI.Text("radial X T").setClass("param").setWidth("50%"),x);var R=(new UI.Number).onChange(l);biasValueRow.add(new UI.Text("radial Y T").setClass("param").setWidth("50%"),R);var T=(new UI.Number).onChange(l);biasValueRow.add(new UI.Text("axial T").setClass("param").setWidth("50%"),T),rotationValueRow=(new UI.Row).setDisplay("none"),M.add(rotationValueRow);var C=(new UI.Number).setRange(-30,30).onChange(l);rotationValueRow.add(new UI.Text("radial X R").setClass("param").setWidth("50%"),C);var I=(new UI.Number).setRange(-30,30).onChange(l);rotationValueRow.add(new UI.Text("radial Y R").setClass("param").setWidth("50%"),I);var S=(new UI.Number).onChange(l);rotationValueRow.add(new UI.Text("axial R").setClass("param").setWidth("50%"),S),sizeValueRow=(new UI.Row).setDisplay("none"),M.add(sizeValueRow);var P=(new UI.Number).onChange(l);sizeValueRow.add(new UI.Text("radial X S").setClass("param").setWidth("50%"),P);var H=(new UI.Number).onChange(l);sizeValueRow.add(new UI.Text("radial Y S").setClass("param").setWidth("50%"),H);let U={bias:biasValueRow,rotation:rotationValueRow,size:sizeValueRow},D={bias:i,rotation:n,size:a},V={bias:[0,0,0],rotation:[0,0,0],size:[1,1,1]};return c.objectSelected.add(function(t){if(!(t instanceof Unit&&""!=e.currentMorph))return void M.setDisplay("none");M.setDisplay("");let s=u[e.currentMorph],i=e.unitMorphKeys[s],n=i.indexOf(t),a=e.sculpture.units.children,r=a.indexOf(t);if(n<0)for(k in E.setValue(!1),E.dom.disabled=!1,u)U[u[k]].setDisplay("none");else for(k in E.setValue(!0),D[s](t),0==r||r==a.length-1?E.dom.disabled=!0:E.dom.disabled=!1,U)s==k?U[k].setDisplay(""):U[k].setDisplay("none")}),c.unitMorphed.add(function(t){let s=t.userData.morphTrans.bias,i=t.userData.morphTrans.rotation,n=t.userData.morphTrans.size;switch(e.currentMorph){case"T":x.setValue(s[0]),R.setValue(s[1]),T.setValue(s[2]);break;case"R":C.setValue(i[0]),I.setValue(i[1]),S.setValue(i[2]);break;case"S":P.setValue(n[0]),H.setValue(n[1])}l()}),d};var Menubar=function(e){function t(e,t){return"number"==typeof t?parseFloat(t.toFixed(i)):t}function s(t){"unit-scene"==t?(f.dom.classList.remove("selected"),m.dom.classList.add("selected")):(f.dom.classList.add("selected"),m.dom.classList.remove("selected")),e.switchScene(t)}var i=6;signals=e.signals;var n=new UI.Panel;n.setId("menubar");var a=new UI.Text("Kineticist").setWidth("150px").setFontSize("40px");a.setMarginLeft("10px"),a.dom.style.verticalAlign="top",a.dom.style.fontFamily="Impact",n.add(a);var r=new UI.Row;n.add(r);var o=(new UI.Button).setId("new").onClick(function(){confirm("start a new project, while unsaved work will be lost, still continue?")&&(e.clear(),signals.sceneCleared.dispatch())});o.dom.title="new",r.add(o);var l=new FileReader;l.addEventListener("load",function(t){var s,i=t.target.result;try{s=JSON.parse(i)}catch(e){return void alert(e)}e.clear(),e.fromJSON(s)},!1);var h=document.createElement("form");h.style.display="none",document.body.appendChild(h);var c=document.createElement("input");c.multiple=!1,c.type="file",c.addEventListener("change",function(e){l.readAsText(c.files[0]),h.reset()}),h.appendChild(c);var u=(new UI.Button).setId("open").onClick(function(){c.click()});u.dom.title="open",r.add(u);var d=(new UI.Button).setId("save").onClick(function(){saveString(JSON.stringify(e.toJSON(),t,"\t"),"sculpture.json")});d.dom.title="save",r.add(d);var p=new UI.Row;n.add(p);var m=(new UI.Button).setId("unit-scene").onClick(function(){s("unit-scene")});p.add(m);var f=(new UI.Button).setId("sculpture-scene").onClick(function(){s("sculpture-scene")});p.add(f);var g=new UI.Row;n.add(g);var w=(new UI.Button).setId("play").onClick(function(){e.isPlay?(e.isPlay=!1,w.setId("play")):(e.isPlay=!0,w.setId("pause"))});g.add(w);var v=(new UI.Button).setId("reset").onClick(function(){e.isPlay=!1,w.setId("play"),e.sculpture.reset()});g.add(v);var y=(new UI.Row).setDisplay("none");n.add(y);var M=[],b=(new UI.Button).setId("translate").onClick(function(){signals.transformModeChanged.dispatch("translate")});y.add(b),M.push(b);var E=(new UI.Button).setId("rotate").onClick(function(){signals.transformModeChanged.dispatch("rotate")});y.add(E),M.push(E);var x=(new UI.Button).setId("scale").onClick(function(){signals.transformModeChanged.dispatch("scale")});y.add(x),M.push(x),y.add(new UI.Text("world").setFontSize("20px").setMargin("8px"));var R=new UI.Checkbox(!1).onChange(function(){signals.worldTransform.dispatch(R.getValue())});y.add(R);var T=(new UI.Button).setId("remove").onClick(function(){e.remove(e.selected)});y.add(T);(new UI.Button).setId("video").setPosition("absolute").setRight("80px").onClick(function(){window.open("https://github.com/hermanncain/Cycler")}),(new UI.Button).setId("github").setPosition("absolute").setRight("20px").onClick(function(){window.open("https://github.com/hermanncain/Cycler")});var C=document.createElement("a");return C.id="fordld",C.style.display="none",document.body.appendChild(C),signals.transformModeChanged.add(function(e){for(bt of M)bt.dom.id==e?bt.dom.classList.add("selected"):bt.dom.classList.remove("selected")}),signals.objectSelected.add(function(e){!e||e instanceof Unit?y.setDisplay("none"):(y.setDisplay(""),"control point"==e.name||"ribpoint"==e.name?(b.setDisplay(""),E.setDisplay("none"),x.setDisplay("none"),T.setDisplay("none")):(e instanceof Rib||e instanceof Sketch)&&(b.setDisplay("none"),E.setDisplay(""),x.setDisplay(""),T.setDisplay("")))}),s(e.currentScene.name),n};Rib.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:Rib,clone:function(){let e=this.end.clone();e.material=this.end.material.clone();let t=new Rib(e);t.curveMaterial=this.curveMaterial.clone(),t.initialize(),t.p1.position.copy(this.p1.position),t.p2.position.copy(this.p2.position),t.endContainer.applyMatrix(this.endContainer.matrix),t.point1Container.applyMatrix(this.point1Container.matrix),t.point2Container.applyMatrix(this.point2Container.matrix),t.curveContainer.applyMatrix(this.curveContainer.matrix);for(let e of this.markerContainer.children)t.markerContainer.add(e.clone());return t.markerContainer.applyMatrix(this.markerContainer.matrix),t.applyMatrix(this.matrix),t.buildCurve(),t.sweepSteps=this.sweepSteps,t.sectionShape=this.sectionShape,t.sectionShapeParams=this.sectionShapeParams,t.widthControls=this.widthControls,t.thicknessControls=this.thicknessControls,t.twistControls=this.twistControls,t.widths=this.widths,t.thicknesses=this.thicknesses,t.twists=this.twists,t},dispose:function(){this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})},setEnd:function(e){this.end=e,this.endContainer.add(this.end)},initialize:function(){this.point1Container.children=[],this.point2Container.children=[];let e=this.end.position.clone().applyMatrix4(this.endContainer.matrix),t=new THREE.BufferGeometry;t.addAttribute("position",new THREE.BufferAttribute(new Float32Array([0,0,0]),3)),this.p1=new THREE.Points(t,this.end.material.clone()),this.p1.name="ribpoint",this.p1.layers.set(1),this.p2=this.p1.clone(),this.p2.material=this.p1.material.clone(),this.p1.position.copy(e.clone().multiplyScalar(1/3)),this.p2.position.copy(e.clone().multiplyScalar(2/3)),this.point1Container.add(this.p1),this.point2Container.add(this.p2),this.buildCurve()},buildCurve:function(){this.curveContainer.children=[];let e=this.end.position.clone().applyMatrix4(this.endContainer.matrix),t=this.p1.position.clone().applyMatrix4(this.point1Container.matrix),s=this.p2.position.clone().applyMatrix4(this.point2Container.matrix);this.curve=new THREE.CatmullRomCurve3([this.start,t,s,e]);let i=this.curve.getPoints(200);this.buildGeometry(i);for(let e=0;e<this.markerContainer.children.length;e++){let t=this.markerContainer.children[e];this.updateMarker(e,t.pos,t.sca,t.shape)}this.translated||(this.endPosition=this.end.position.clone().applyMatrix4(this.endContainer.matrix),this.p1Position=this.p1.position.clone().applyMatrix4(this.point1Container.matrix),this.p2Position=this.p2.position.clone().applyMatrix4(this.point2Container.matrix))},buildGeometry:function(e){var t=null,s=null;this.skeleton?(this.setPointSize(.2),t=new THREE.TubeBufferGeometry(this.curve,200,.05,4),s=new THREE.Mesh(t,new THREE.MeshBasicMaterial({color:65535})),s.layers.set(3),s.name="ribcurve",this.curveContainer.add(s)):(t=new THREE.BufferGeometry,t.setFromPoints(e),s=new THREE.Line(t,this.curveMaterial),s.name="ribcurve",s.layers.set(3),this.curveContainer.add(s))},select:function(){this.setColor(16755200)},deselect:function(){this.setColor(255)},setColor:function(e){this.end.material.color.setHex(e),this.p1.material.color.setHex(e),this.p2.material.color.setHex(e),this.curveContainer.children[0].material.color.setHex(e)},setPointSize:function(e){this.end.material.size=e,this.p1.material.size=e,this.p2.material.size=e},getEndPosition:function(){let e=this.end.position.clone();return e.applyMatrix4(this.endContainer.matrix),e.applyMatrix4(this.matrix),e},getServoCylindrical:function(e){let t=Math.atan2(this.end.position.x,this.end.position.y),s=Math.sqrt(e.position.x**2+e.position.y**2),i="vp"==e.name?t:Math.atan2(e.position.x,e.position.y)-t,n=e.position.z;return{r:s,t:i,h:n}},setServoCylindrical:function(e,t){let s="vp"==e.name?t.t:t.t+Math.atan2(this.end.position.x,this.end.position.y),i=t.r*Math.sin(s),n=t.h,a=t.r*Math.cos(s);e.position.set(i,a,n),this.curve&&this.buildCurve()},unitToRib:function(e){let t=Math.atan2(this.end.position.y,this.end.position.x),s=new THREE.Euler(0,0,-t),i=e.clone().applyEuler(s);return i},ribToUnit:function(e){let t=Math.atan2(this.end.position.y,this.end.position.x),s=new THREE.Euler(0,0,t),i=e.clone().applyEuler(s);return i},allPointsToRib:function(){let e=this.unitToRib(this.p1.position),t=this.unitToRib(this.p2.position),s=this.unitToRib(this.end.position);return[e,t,s]},updatePointFromRib:function(e,t){e.copy(this.ribToUnit(t)),this.curve&&this.buildCurve()},updatePointsFromRib:function(e,t){this.p1.position.copy(this.ribToUnit(e)),this.p2.position.copy(this.ribToUnit(t)),this.curve&&this.buildCurve()},getBias:function(){let[e,t,s]=this.allPointsToRib();return(e.x+t.x)/s.x-1},setBias:function(e){let[t,s,i]=this.allPointsToRib(),n=s.x-t.x;t.x=i.x/2-n/2+e/2*i.x,s.x=i.x/2+n/2+e/2*i.x,this.updatePointsFromRib(t,s)},getSep:function(){let[e,t,s]=this.allPointsToRib();return(t.x-e.x)/s.x},setSep:function(e){let[t,s,i]=this.allPointsToRib(),n=(t.x+s.x)/2;t.x=n-e*i.x/2,s.x=n+e*i.x/2,this.updatePointsFromRib(t,s)},getTangentArch:function(){let[e,t,s]=this.allPointsToRib();return-(e.y+t.y)/s.x},setTangentArch:function(e){let[t,s,i]=this.allPointsToRib(),n=-e*i.x/2,a=(s.y-t.y)/2;t.y=n+a,s.y=n-a,this.updatePointsFromRib(t,s)},getTangentWave:function(){let[e,t,s]=this.allPointsToRib();return(t.y-e.y)/s.x},setTangentWave:function(e){let[t,s,i]=this.allPointsToRib(),n=(t.y+s.y)/2,a=e*i.x/2;t.y=n-a,s.y=n+a,this.updatePointsFromRib(t,s)},getAxialArch:function(){let[e,t,s]=this.allPointsToRib(),i=Math.atan2(s.z,s.x);return(e.z+t.z-s.z/s.x*(e.x+t.x))*Math.cos(i)**2/s.x},setAxialArch:function(e){let[t,s,i]=this.allPointsToRib(),n=Math.atan2(i.z,i.x);this.p1.position.z=e*i.x/Math.cos(n)**2/2+t.x/i.x*i.z,this.p2.position.z=e*i.x/Math.cos(n)**2/2+s.x/i.x*i.z,this.curve&&this.buildCurve()},getAxialWave:function(){let[e,t,s]=this.allPointsToRib(),i=Math.atan2(s.z,s.x);return(e.z-t.z+s.z/s.x*(t.x-e.x))*Math.cos(i)**2/s.x},setAxialWave:function(e){let[t,s,i]=this.allPointsToRib(),n=Math.atan2(i.z,i.x),a=e*i.x/Math.cos(n)**2/2,r=(s.x-t.x)/2*Math.tan(n),o=(t.z+s.z)/2;this.p1.position.z=o-r+a,this.p2.position.z=o+r-a,this.curve&&this.buildCurve()},setMorphScale:function(e,t,s){this.endContainer.scale.set(e,t,s),this.end.scale.set(1/e,1/t,1/s),this.point1Container.scale.set(e,t,s),this.p1.scale.set(1/e,1/t,1/s),this.point2Container.scale.set(e,t,s),this.p2.scale.set(1/e,1/t,1/s),this.endContainer.updateMatrix(),this.point1Container.updateMatrix(),this.point2Container.updateMatrix()},resetMorphScale:function(){this.endContainer.scale.set(1,1,1),this.end.scale.set(1,1,1),this.point1Container.scale.set(1,1,1),this.p1.scale.set(1,1,1),this.point2Container.scale.set(1,1,1),this.p2.scale.set(1,1,1),this.endContainer.updateMatrix(),this.point1Container.updateMatrix(),this.point2Container.updateMatrix()},resetMorphTranslation:function(){this.end.position.copy(this.endPosition),this.p1.position.copy(this.p1Position),this.p2.position.copy(this.p2Position)},setMorphTranslation:function(e,t,s){this.resetMorphTranslation();let i=this.end.position.distanceTo(new THREE.Vector3),n=this.p1.position.distanceTo(new THREE.Vector3)/i,a=this.p2.position.distanceTo(new THREE.Vector3)/i;this.end.position.x+=e,this.end.position.y+=t,this.end.position.z+=s,this.p1.position.x+=e*n,this.p1.position.y+=t*n,this.p1.position.z+=s*n,this.p2.position.x+=e*a,this.p2.position.y+=t*a,this.p2.position.z+=s*a,this.end.updateMatrix(),this.p1.updateMatrix(),this.p2.updateMatrix(),this.translated=!0},getTNB:function(e){let t=this.curve.getTangent(e);return t.applyMatrix4(this.endContainer.matrix).applyMatrix4(this.matrix)},addMarker:function(e,t,s){let i=new Marker(e,t,s),n=this.curve.getPointAt(e);i.position.copy(n),this.markerContainer.add(i)},updateMarker:function(e,t,s,i){let n=this.markerContainer.children[e];n.update(t,s,i);let a=this.curve.getPointAt(t);n.position.copy(a)},removeMarker:function(e){let t=this.markerContainer.children[e];this.markerContainer.children.splice(e,1),t.dispose()},clearMarker:function(){for(;this.markerContainer.children.length>0;){let e=this.markerContainer.children.pop();e.dispose()}},getInstallAngle:function(e){let t=this.curve.getPoints(100);for(let s of t)if(s.applyMatrix4(this.matrix),s.x**2+s.y**2>e)return Math.atan2(s.y,s.x)},toJSON:function(){return{end:this.end.position.toArray(),p1:this.p1.position.toArray(),p2:this.p2.position.toArray(),matrix:this.matrix.toArray(),endContainerMatrix:this.endContainer.matrix.toArray(),p1ContainerMatrix:this.point1Container.matrix.toArray(),p2ContainerMatrix:this.point2Container.matrix.toArray(),curveContainerMatrix:this.curveContainer.matrix.toArray(),markerContainerMatrix:this.markerContainer.matrix.toArray(),markers:this.markerContainer.children.map(function(e){return e.toJSON()}),sweepSteps:this.sweepSteps,sectionShape:this.sectionShape,sectionShapeParams:this.sectionShapeParams,widthControls:this.widthControls,thicknessControls:this.thicknessControls,twistControls:this.twistControls,widths:this.widths,thicknesses:this.thicknesses,twists:this.twists,translated:this.translated,skeleton:this.skeleton}},fromJSON:function(e){let t=new THREE.BufferGeometry;t.addAttribute("position",new THREE.BufferAttribute(new Float32Array([0,0,0]),3));let s=new THREE.Points(t,new THREE.PointsMaterial({color:255}));for(m of(s.name="ribpoint",s.layers.set(1),s.position.copy((new THREE.Vector3).fromArray(e.end)),this.sweepSteps=e.sweepSteps,this.sectionShape=e.sectionShape,this.sectionShapeParams=e.sectionShapeParams,this.widthControls=e.widthControls,this.thicknessControls=e.thicknessControls,this.twistControls=e.twistControls,this.widths=e.widths,this.thicknesses=e.thicknesses,this.twists=e.twists,this.translated=e.translated,this.skeleton=e.skeleton,this.setEnd(s),this.initialize(),e.markers))this.addMarker(m.pos,m.sca,m.shape);this.p1.position.copy((new THREE.Vector3).fromArray(e.p1)),this.p2.position.copy((new THREE.Vector3).fromArray(e.p2)),this.endContainer.applyMatrix((new THREE.Matrix4).fromArray(e.endContainerMatrix)),this.point1Container.applyMatrix((new THREE.Matrix4).fromArray(e.p1ContainerMatrix)),this.point2Container.applyMatrix((new THREE.Matrix4).fromArray(e.p2ContainerMatrix)),this.curveContainer.applyMatrix((new THREE.Matrix4).fromArray(e.curveContainerMatrix)),this.markerContainer.applyMatrix((new THREE.Matrix4).fromArray(e.markerContainerMatrix)),this.applyMatrix((new THREE.Matrix4).fromArray(e.matrix)),this.buildCurve()}}),Marker.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:Marker,clone:function(){let e=new Marker(this.pos,this.sca,this.shape);return e.applyMatrix(this.matrix),e},dispose:function(){this.pt.geometry.dispose()},update:function(e=1,t=1,s="plate"){this.pos=e,this.sca=t,this.shape=s},toJSON:function(){return{pos:this.pos,sca:this.sca,shape:this.shape}},fromJSON:function(e){this.update(e.pos,e.sca,e.shape)}});var Rightbar=function(e){function t(t){for(var i=e.camera.layers.mask.toString(2);i.length<=e.camLayers;)i="0"+i;i=i.split("").reverse().join(""),1==i[t]?e.camera.layers.disable(t):0==i[t]&&e.camera.layers.enable(t),s()}function s(){for(var t=e.camera.layers.mask.toString(2);t.length<=e.camLayers;)t="0"+t;t=t.split("").reverse(),t.shift(),t=t.join("");for(let e=0;e<t.length;e++)"1"==t[e]?f[e].dom.classList.add("selected"):"0"==t[e]&&f[e].dom.classList.remove("selected")}function i(t){e.unitScene.background.name!=t&&(e.changeScene(t),n())}function n(){for(let t of w)t.dom.id==e.unitScene.background.name?t.dom.classList.add("selected"):t.dom.classList.remove("selected");e.unitScene.background.isColor?w[0].dom.classList.add("selected"):w[0].dom.classList.remove("selected")}var a=e.signals,r=(new UI.Panel).setId("rightbar"),o=(new UI.Panel).setId("camera-row");r.add(o),o.add(new UI.Text("Camera").setClass("bar-title"));let l=(new UI.Row).setMarginLeft("10px");o.add(l),l.add(new UI.Text("visibility").setWidth("100%"));let h=(new UI.Button).setId("point-layer").onClick(function(){t(1)});l.add(h);let c=(new UI.Button).setId("line-layer").onClick(function(){t(2)});l.add(c);let u=(new UI.Button).setId("bone-layer").onClick(function(){t(3)});l.add(u);let d=(new UI.Button).setId("mesh-layer").onClick(function(){t(4)});l.add(d);let p=(new UI.Button).setId("env-layer").onClick(function(){t(5)});l.add(p);let m=(new UI.Button).setId("helper-layer").onClick(function(){t(6)});l.add(m);let f=[h,c,u,d,p,m];r.add(new UI.Text("Material").setClass("bar-title"));var g=(new UI.Row).setId("scene-row");r.add(g),g.add(new UI.Text("Scene").setMargin("10px"));var w=[],v=(new UI.Row).setMarginLeft("10px");g.add(v),function(){for(let t in backgrounds){var e=(new UI.Button).setId(t).onClick(function(){i(t)});v.add(e),w.push(e)}}();var y=(new UI.Row).setId("unit-row");r.add(y),y.add(new UI.Text("Unit").setMargin("10px"));var M=(new UI.Select).setWidth("80px").setMarginLeft("20px").onChange(function(){let t=M.getValue();switch(t){case"0":e.setMaterial(grayMaterial);break;case"1":e.setMaterial(metalMaterial);break;case"2":e.setMaterial("color")}});y.add(M),M.setMultiple=!1,M.setOptions(["gray","metal","colored"]),M.setValue(0);var b=new UI.Row,E=!1;let x=new UI.Button("single").onClick(function(){let t=e.sculpture,s=t.units.children.length;if(E)t.units.children.map(function(e){e.visible=!0}),E=!1;else{for(let e=0;e<s;e++)3!=e&&(t.units.children[e].visible=!1);E=!0}});b.add(x);var R=!1;let T=new UI.Button("pair").onClick(function(){let t=e.sculpture,s=t.units.children.length;if(R)t.units.children.map(function(e){e.visible=!0}),R=!1;else{for(let e=0;e<s;e++)3!=e&&4!=e&&(t.units.children[e].visible=!1);R=!0}});b.add(T);var C=!1;let k=new UI.Button("hide").onClick(function(){let t=e.sculpture.units.children;C?(t.map(function(e){e.visible=!0}),C=!1):(t.map(function(e){e.visible=!1}),C=!0)});b.add(k);var I=new Rightbar.Geometry(e);return r.add(I),s(),n(),t(5),a.objectSelected.add(function(e){e instanceof Sketch?I.setDisplay(""):I.setDisplay("none")}),r};Rightbar.Geometry=function(e){function t(e){for(let t=0;t<o.length;t++)t==e?o[t].dom.classList.add("selected"):o[t].dom.classList.remove("selected")}function s(t){t?(h.clear(),curveMap[t.name]||surfaceMap[t.name]?(n.setDisplay(""),h.add(new Rightbar.Geometry[t.name](e,t))):n.setDisplay("none")):n.setDisplay("none")}var i=e.signals,n=(new UI.Panel).setId("rightbar-geometry").setDisplay("none");n.add(new UI.Text("Geometry").setClass("bar-title"));var a=new UI.Row;a.add(new UI.Text("Time order").setFontSize("20px").setWidth("100%"));var r=new UI.Button("none").onClick(function(){e.selected instanceof Sketch&&e.selected.setTimeOrder(0)});a.add(r);var o=[r];for(let s=1;s<5;s++){var l=new UI.Button(s).setBackgroundColor("#"+timeOrderColors[s].toString(16)).onClick(function(){t(s),e.selected.setTimeOrder(s)});a.add(l),o.push(l)}var h=new UI.Span;return n.add(h),i.objectSelected.add(function(e){e&&e instanceof Sketch?(s(e),h.setDisplay("")):h.setDisplay("none")}),n},Rightbar.Geometry.Ellipse=function(e,t){function s(){t.parameters[2]=o.getValue(),t.parameters[3]=l.getValue(),t.parameters[4]=c.getValue(),t.parameters[5]=u.getValue(),t.parameters[6]=p.getValue(),t.parameters[7]=f.getValue(),t.buildMesh(),t.select()}var i=(new UI.Row).add(new UI.Text("Ellipse").setClass("sect-title")),n=t.parameters,a=(new UI.Panel).setClass("content");i.add(a);var r=new UI.Row;r.add(new UI.Text("Radii").setWidth("70px")),a.add(r);var o=new UI.Number(n[2]).onChange(s),l=new UI.Number(n[3]).onChange(s);r.add(o),r.add(l);var h=new UI.Row;a.add(h),h.add(new UI.Text("Start angle"));var c=new UI.Number(n[4]).setUnit("°").setWidth("50px").onChange(s);h.add(c),h.add(new UI.Text("End angle"));var u=new UI.Number(n[5]).setUnit("°").setWidth("50px").onChange(s);h.add(u);var d=new UI.Row;d.add(new UI.Text("Clockwise")),a.add(d);var p=new UI.Checkbox(n[6]).onChange(s);d.add(p);var m=new UI.Row;m.add(new UI.Text("Rotation")),a.add(m);var f=new UI.Number(n[7]).setUnit("°").onChange(s);return m.add(f),i},Rightbar.Geometry.DecoratedTorusKnot=function(e,t){function s(){for(let e=0;e<r.length;e++)t.parameters[e]=r[e].getValue();t.buildMesh(),t.setMaterialColor(16755200)}var i=(new UI.Row).add(new UI.Text("Decorated Torus Knot").setClass("sect-title")),n=t.parameters,a=(new UI.Panel).setClass("content");i.add(a);var r=[],o=["Inner rotation","Out lotus","Radical phase","Inner lotus","Lotus phase","Depth","Deep phase"];for(let e=0;e<7;e++){var l=new UI.Row;a.add(l),l.add(new UI.Text(o[e]).setWidth("100px"));var h=new UI.Number(n[e]).onChange(s);r.push(h),l.add(h)}return i},Rightbar.Geometry.Sin=function(e,t){function s(){t.parameters[0]=o.getValue(),t.parameters[1]=h.getValue(),t.parameters[2]=u.getValue(),t.parameters[3]=p.getValue(),t.parameters[4]=m.getValue(),t.buildMesh(),t.setMaterialColor(16755200)}var i=(new UI.Row).add(new UI.Text("Sine").setClass("sect-title")),n=t.parameters,a=(new UI.Panel).setClass("content");i.add(a);var r=new UI.Row;a.add(r),r.add(new UI.Text("Amplitude"));var o=new UI.Number(n[0]).onChange(s);r.add(o);var l=new UI.Row;a.add(l),l.add(new UI.Text("Frequency"));var h=new UI.Number(n[1]).onChange(s);l.add(h);var c=new UI.Row;a.add(c),c.add(new UI.Text("Phase"));var u=new UI.Number(n[2]).onChange(s);c.add(u);var d=new UI.Row;d.add(new UI.Text("Range").setWidth("70px")),a.add(d);var p=new UI.Number(n[3]).onChange(s),m=new UI.Number(n[4]).onChange(s);return d.add(p),d.add(m),i},Rightbar.Geometry.Spiral=function(e,t){function s(){t.parameters[0]=o.getValue(),t.parameters[1]=h.getValue(),t.parameters[2]=u.getValue(),t.parameters[3]=p.getValue(),t.buildMesh(),t.setMaterialColor(16755200)}var i=(new UI.Row).add(new UI.Text("Spiral / Helix").setClass("sect-title")),n=t.parameters,a=(new UI.Panel).setClass("content");i.add(a);var r=new UI.Row;r.add(new UI.Text("Radius").setWidth("100px")),a.add(r);var o=new UI.Number(n[0]).onChange(s);r.add(o);var l=new UI.Row;l.add(new UI.Text("Radial pitch").setWidth("100px")),a.add(l);var h=new UI.Number(n[1]).onChange(s);l.add(h);var c=new UI.Row;c.add(new UI.Text("Pitch").setWidth("100px")),a.add(c);var u=new UI.Number(n[2]).onChange(s);c.add(u);var d=new UI.Row;d.add(new UI.Text("Number").setWidth("100px")),a.add(d);var p=new UI.Number(n[3]).onChange(s);return d.add(p),i},Rightbar.Geometry.TorusKnot=function(e,t){function s(){t.parameters[0]=o.getValue(),t.parameters[1]=h.getValue(),t.parameters[2]=u.getValue(),t.parameters[3]=p.getValue(),t.buildMesh(),t.select()}var i=(new UI.Row).add(new UI.Text("TorusKnot").setClass("sect-title")),n=t.parameters,a=(new UI.Panel).setClass("content");i.add(a);var r=new UI.Row;a.add(r),r.add(new UI.Text("Radius"));var o=new UI.Number(n[0]).onChange(s);r.add(o);var l=new UI.Row;a.add(l),l.add(new UI.Text("Torus radius"));var h=new UI.Number(n[1]).onChange(s);l.add(h);var c=new UI.Row;a.add(c),c.add(new UI.Text("p"));var u=new UI.Integer(n[2]).onChange(s);c.add(u);var d=new UI.Row;a.add(d),d.add(new UI.Text("q"));var p=new UI.Integer(n[3]).onChange(s);return d.add(p),i};class Sculptor{constructor(){var e=this;this.scene=new THREE.Scene,this.scene.background=backgrounds.none;var t=[];t[0]=new THREE.AmbientLight(7895160),t[1]=new THREE.PointLight(16777215,1,0),t[2]=new THREE.PointLight(16777215,1,0),t[3]=new THREE.PointLight(16777215,1,0),t[1].position.set(0,200,0),t[2].position.set(100,200,100),t[3].position.set(-100,-200,-100),t.map(function(t){e.scene.add(t)}),this.sceneHelpers=new THREE.Scene;var s=new THREE.AxesHelper(5);s.layers.set(6),this.sceneHelpers.add(s),this.camera=new THREE.PerspectiveCamera(45,1,.1,1e4),this.initialCameraPosition=new THREE.Vector3(0,0,50),this.camLayers=6;for(let e=1;e<=this.camLayers;e++)this.camera.layers.enable(e);this.camera.position.set(0,0,50),this.unitCanvas=new THREE.Mesh(new THREE.PlaneBufferGeometry(200,200)),this.unitCanvas.position.set(0,0,0),this.sketchCanvas=new THREE.Mesh(new THREE.PlaneBufferGeometry(200,200)),this.sketchCanvas.position.set(0,0,-50),this.camera.add(this.sketchCanvas),this.clear();var i=signals.Signal;this.signals={windowResize:new i,cameraChanged:new i,drawModeChanged:new i,play:new i,pause:new i,generateSkeleton:new i,objectSelected:new i,worldTransform:new i,objectTransformed:new i,transformModeChanged:new i,unitTypeChanged:new i,unitMorphed:new i,setMorphControl:new i,removeMorphControl:new i,leftbarChanged:new i,sceneChanged:new i,sceneCleared:new i,unitScaleChanged:new i,sketchChanged:new i,sculptureChanged:new i,infoChanged:new i}}clear(){this.unitScene=this.scene.clone(),this.unitScene.name="unit-scene",this.sculptureScene=this.scene.clone(),this.sculptureScene.name="sculpture-scene",this.currentScene=this.unitScene,this.currentMaterial=grayMaterial,this.showKeys=!1,this.drawMode="normal",this.selectMode="normal",this.selected=null,this.selectedGroup=[],this.selectedObjects=[],this.unit=new Unit,this.unit.setMaterial(grayMaterial),this.unitScene.add(this.unit),this.sculpture=new KineticSculpture,this.sculpture.unit=this.unit,this.sculptureScene.add(this.sculpture),this.sketches=[],this.currentMorph="",this.unitMorphKeys={bias:[],rotation:[],size:[]},this.isPlay=!1}select(e,t=!1){if(t)this.selectedObjects.indexOf(e)>-1?(this.unselect(e),this.selectedObjects.splice(this.selectedObjects.indexOf(e),1)):e instanceof Rib&&(this.selectedObjects.push(e),this.selected=e,this.selected.select());else{if(this.selected===e){if(!(this.selectedObjects.length>0))return;this.multiUnselect()}null!=this.selected&&this.unselect(this.selected),this.selectedObjects.length>0&&this.multiUnselect(),this.selected=e,null!=e?this.selected instanceof Sketch||this.selected instanceof Rib?this.selected.select():this.selected instanceof Unit&&(""==this.currentMorph?this.selected=null:this.selected.setMaterial(selectedMaterial)):this.multiUnselect()}this.signals.objectSelected.dispatch(this.selected)}unselect(e){if(null!=e)if(e instanceof Sketch||e instanceof Rib)e.deselect();else if("ribpoint"==e.name)e.material.color.setHex(255);else if("control point"==e.name)e.material.color.setHex(255),e.material.color.copy(e.parent.material.color);else if(e instanceof Unit)if(this.showKeys){let t=!1;for(let s in this.unitMorphKeys)if(this.unitMorphKeys[s].indexOf(e)>-1){t=!0;break}t?e.setMaterial(labeledMaterial):e.setMaterial(this.currentMaterial)}else e.setMaterial(this.currentMaterial)}multiUnselect(){for(let e of this.selectedObjects)this.unselect(e);this.selectedObjects=[]}deselect(){this.select(null)}remove(e){e&&(e instanceof Rib?this.unit.removeRib(e):e instanceof Sketch&&(this.removeSketch(e),e.dispose()),this.deselect())}addSketch(e){this.sculptureScene.add(e),this.sketches.push(e),this.signals.sketchChanged.dispatch()}removeSketch(e){this.sculptureScene.remove(e),this.sketches.indexOf(e)>-1&&(this.sketches.splice(this.sketches.indexOf(e),1),this.signals.sketchChanged.dispatch())}setRole(e,t){if(e.role==t)return;let s=this.sculpture;if(s.contours=[],"axis"==t||"reference"==t)for(let e of this.sketches)if(e.role==t){e.setRole("sketch");break}e.setRole(t);for(let e of this.sketches)"axis"==e.role?s.axis=e:"reference"==e.role?s.reference=e:"contour"==e.role&&s.contours.push(e);"axis"==t&&this.signals.unitScaleChanged.dispatch()}switchScene(e){this.currentScene="unit-scene"==e?this.unitScene:this.sculptureScene,this.signals.sceneChanged.dispatch(e)}changeScene(e){
"none"!=e&&(metalMaterial.envMap=backgrounds[e]),this.unitScene.background=backgrounds[e],this.sculptureScene.background=backgrounds[e]}setMaterial(e){this.currentMaterial=e,sculptor.unit.setMaterial(e),this.sculpture&&this.sculpture.units.children.map(function(t){t.setMaterial(e)})}layout(e){this.sculpture.layout(this.unit,e),this.resetMorphKeys(),this.signals.objectSelected.dispatch(null)}resetMorphKeys(){this.unitMorphKeys.bias=[],this.unitMorphKeys.rotation=[],this.unitMorphKeys.size=[],this.unitMorphKeys.bias.push(this.sculpture.units.children[0]),this.unitMorphKeys.bias.push(this.sculpture.units.children[this.sculpture.units.children.length-1]),this.unitMorphKeys.rotation.push(this.sculpture.units.children[0]),this.unitMorphKeys.rotation.push(this.sculpture.units.children[this.sculpture.units.children.length-1]),this.unitMorphKeys.size.push(this.sculpture.units.children[0]),this.unitMorphKeys.size.push(this.sculpture.units.children[this.sculpture.units.children.length-1])}solveSkeletons(e){let t=[];this.sculpture.sketches.map(function(e){void 0===t[e.timeOrder-1]?t[e.timeOrder-1]=[e]:t[e.timeOrder-1].push(e)});let s=t[0].length;for(let e of t)if(s!=e.length)return void alert("sketches should have the same number of curves!");this.unit.dispose(),this.solver=new prototypeSolver(t,null,e,this.unit,this.sculpture),this.solver.initializeAxis(!0),this.axis=this.solver.axis}testAxisGen(e){this.solver.n=e,this.solver.generateAxis(!1),this.solver.searchAxisByJuncEnv(),this.axis=this.solver.axis}testJunction(e){this.solver.initializeJunctionEnvelopes()}toJSON(){let e=this;return{morphControlIdx:{bias:this.unitMorphKeys.bias.map(function(t){return e.sculpture.units.children.indexOf(t)}),rotation:this.unitMorphKeys.rotation.map(function(t){return e.sculpture.units.children.indexOf(t)}),size:this.unitMorphKeys.size.map(function(t){return e.sculpture.units.children.indexOf(t)})},unit:this.unit.toJSON(),sketches:this.sketches.map(function(e){return e.toJSON()}),sculpture:this.sculpture.toJSON()}}fromJSON(e){this.clear(),this.unit.fromJSON(e.unit);for(let t of e.sketches){let s=(new Sketch).fromJSON(t);this.addSketch(s),s.eid==e.sculpture.axisId?(this.sculpture.setAxis(s),this.axis=s):e.sculpture.sketchIds.indexOf(s.eid)>=0&&this.sculpture.addContour(s)}this.layout(e.sculpture.params);for(let t in this.unitMorphKeys){this.unitMorphKeys[t]=[];for(let s of e.morphControlIdx[t])this.unitMorphKeys[t].push(this.sculpture.units.children[s])}this.sculpture.fromJSON(e.sculpture),this.signals.sceneChanged.dispatch("unitScene")}deselectGroup(){0!=this.selectedGroup.length&&(this.selectedGroup[0]instanceof Rib?this.selectedGroup.map(function(e){e.deselect()}):"ribpoint"==this.selectedGroup[0].name&&this.selectedGroup.map(function(e){e.material.color.setHex(255)}))}}Sketch.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:Sketch,clone:function(){return(new Sketch).fromJSON(this.toJSON())},dispose:function(){this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})},setRole:function(e){this.role!=e&&(this.role=e,"axis"==e&&(this.timeOrder=0),this.selected?this.select():this.deselect())},setTimeOrder:function(e){this.role="contour",this.timeOrder=e,this.setMaterialColor(timeOrderColors[e])},select:function(){this.selected=!0,this.setMaterialColor(lineColors.selected)},deselect:function(){this.selected=!1,this.timeOrder>0?this.setMaterialColor(timeOrderColors[this.timeOrder]):this.setMaterialColor(lineColors[this.role])},setMaterialColor:function(e){for(pt of(this.material.color.setHex(e),this.pointMeshes))pt.material.color.setHex(e)},buildCurve:function(){if(this.curve=new THREE.CurvePath,void 0!==this.parameters){let e=curveMap[this.name],t=e(this.parameters);this.curve.add(t),this.closed=t.closed}else if(this.keyPoints.length>0)switch(this.name){case"line":for(let e=0;e<this.keyPoints.length-1;e++)this.curve.add(new THREE.LineCurve3(this.keyPoints[e],this.keyPoints[e+1]));break;case"spline":case"brush2d":case"brush3d":let e=new THREE.CatmullRomCurve3(this.keyPoints,this.closed);e.role="chordal",this.curve.add(e)}this.curve.autoClose=this.closed},buildGeometry:function(){this.densePoints=[],this.denseLines=[];var e=null;this.curveResolution=10*Math.ceil(this.curve.getLength()+1),this.densePoints="line"==this.name?this.keyPoints:this.curve.getPoints(this.curveResolution);var t=this.densePoints.length;switch(lineMode){case lineModes.gl:e=new THREE.Geometry;for(let s=0;s<t-1;s++)this.denseLines.push(new THREE.Line3(this.densePoints[s],this.densePoints[s+1])),e.vertices.push(this.densePoints[s]);e.vertices.push(this.densePoints[t-1]),this.curve.autoClose&&e.vertices.push(this.densePoints[0]);break;case lineModes.tube:for(let e=0;e<t-1;e++)this.denseLines.push(new THREE.Line3(this.densePoints[e],this.densePoints[e+1]));this.curve.autoClose&&this.denseLines.push(new THREE.Line3(this.densePoints[t-1],this.densePoints[0])),e=new THREE.TubeBufferGeometry(this.curve,this.curveResolution/2,this.width/20,3,this.curve.autoClose)}return e},buildPointMesh:function(){for(let e of this.keyPoints){let t=new THREE.BufferGeometry;t.addAttribute("position",new THREE.BufferAttribute(new Float32Array([0,0,0]),3));let s=new THREE.Points(t,new THREE.PointsMaterial({color:this.material.color,size:this.pointSize}));s.name="control point",s.layers.set(1),s.position.copy(e),this.pointMeshes.push(s),this.add(s)}},buildMesh:function(){for(pt of this.pointMeshes)pt.material&&pt.material.dispose(),pt.geometry&&pt.geometry.dispose();switch(this.pointMeshes=[],this.curveMesh&&this.curveMesh.geometry.dispose(),this.curveMesh=null,this.children=[],this.setRole(this.role),this.buildCurve(),lineMode){case lineModes.gl:this.curveMesh=new THREE.Line(this.buildGeometry(),this.material);break;case lineModes.tube:this.curveMesh=new THREE.Mesh(this.buildGeometry(),this.material)}this.curveMesh.layers.set(2),this.curveMesh.name="sketch line",this.add(this.curveMesh),this.keyPoints.length>0&&this.buildPointMesh()},reduce:function(){"brush2d"!=this.name&&"brush3d"!=this.name||(this.keyPoints=simplifyDP(this.keyPoints,5),this.name="spline",this.buildMesh())},sample:function(e,t="curvature"){if(0==this.curve.getLength())return;this.sampleRates=[],this.samplingPoints=[],this.samplingTangents=[],this.samplingNormalPlanes=[];let s=null,i=this.curve.autoClose?e:e-1>0?e-1:1;for(let s=0;s<e;s++){let e,n;this.sampleRates.push(s/i),"average"==t?(e=this.curve.getPointAt(s/i).clone(),n=this.curve.getTangentAt(s/i).clone()):"curvature"==t&&(e=this.curve.getPoint(s/i).clone(),n=this.curve.getTangent(s/i).clone()),e.applyMatrix4(this.curveMesh.matrix),n.applyQuaternion(this.curveMesh.quaternion),n.normalize(),this.samplingPoints.push(e),this.samplingTangents.push(n)}s=this.curve.autoClose?this.curve.computeFrenetFrames(this.samplingPoints.length,this.curve.autoClose):this.curve.computeFrenetFrames(this.samplingPoints.length-1,this.curve.autoClose);for(let e=0;e<s.tangents.length;e++)s.normals[e].applyQuaternion(this.curveMesh.quaternion),s.binormals[e].applyQuaternion(this.curveMesh.quaternion),s.tangents[e].applyQuaternion(this.curveMesh.quaternion);this.ff=s;for(let e=0;e<this.samplingPoints.length;e++){var n=new THREE.Plane(this.samplingTangents[e]);n.translate(this.samplingPoints[e]),this.samplingNormalPlanes.push(n)}},getReferencedFrames:function(e,t=50){this.sample(t);let s=[],i=[],n=[];for(let t=0;t<this.samplingPoints.length;t++){let a=this.samplingPoints[t].clone(),r=e.getNearestIntersection(a,this.samplingNormalPlanes[t]);if(!r){s.push(null),i.push(null),n.push(null);continue}let o=r.clone().sub(this.samplingPoints[t]).normalize(),l=this.samplingTangents[t].clone().cross(o).normalize();s.push(this.samplingTangents[t]),i.push(o),n.push(l)}return{tangents:s,normals:i,binormals:n}},getNearestIntersection:function(e,t){let s=1/0,i=null,n=this.getIntersections(e,t);for(let t of n){let n=t.distanceTo(e);n<s&&(i=t.clone(),s=n)}return i},getIntersections:function(e,t,s=1/0){let i=[],n=new THREE.Vector3;for(line of this.denseLines){let a=line.clone().applyMatrix4(this.curveMesh.matrix);null!=t.intersectLine(a,n)&&(n.distanceTo(e)<s&&i.push(n.clone()))}return i},getNormalIntersectionsWithCurves:function(e,t=1/0){let s=[];for(let i=0;i<this.samplingPoints.length;i++){let n=[],a=this.samplingNormalPlanes[i],r=this.samplingPoints[i];for(sketch of e){let e=sketch.getIntersections(r,a,t);e.length>0&&n.push(...e)}s.push(n)}return s},generateSkeleton:function(e,t=1e3,s=50){this.sample(s);var i=[];for(let s of e){var n=s.intersectWithPlanes(this.samplingPoints,this.samplingNormalPlanes,t);n.length>0&&i.push(...n)}return i},intersectWithPlanes:function(e,t,s=100){if(e.length==t.length){var i=[];for(let a=0;a<t.length;a++){var n=this.intersectWithLimitedPlane(e[a],t[a],s);n.length>0&&i.push(...n)}return i}alert("unequal lengths of plane and plane centers!")},intersectWithLimitedPlane:function(e,t,s){var i=new THREE.Vector3,n=new Unit,a=[];for(line of this.denseLines)a.push(line.clone().applyMatrix4(this.matrix));for(line of a)if(t.intersectsLine(line)){var r=t.intersectLine(line,i);if(r.distanceTo(e)<s){var o=(new THREE.Vector3).subVectors(r,e);n.addRib(o)}}return n},adjustTransform:function(e,t){},toJSON:function(){return{eid:this.uuid,name:this.name,role:this.role,timeOrder:this.timeOrder,closed:this.closed,parameters:this.parameters,keyPoints:this.keyPoints.map(function(e){return e.toArray()}),matrix:this.matrix.toArray()}},fromJSON:function(e){return this.eid=e.eid,this.name=e.name,this.role=e.role?e.role:"sketch",this.timeOrder=e.timeOrder?e.timeOrder:0,this.closed=e.closed,this.parameters=e.parameters,this.keyPoints=e.keyPoints.map(function(e){return(new THREE.Vector3).fromArray(e)}),this.buildMesh(),this.applyMatrix((new THREE.Matrix4).fromArray(e.matrix)),this.deselect(),this}});var Toolbar=function(e){function t(){e.selected instanceof Rib&&(p.dom.id.indexOf("selected")<0?(p.dom.classList.add("selected"),m.setDisplay("inline"),e.unit.clearTemp(),e.unit.generateCircleArray(e.selected,f.getValue())):(p.dom.classList.remove("selected"),m.setDisplay("none")))}function s(){e.unit.clearTemp(),i()}function i(){p.dom.classList.remove("selected"),m.setDisplay("none")}function n(t){e.selected instanceof Sketch&&(e.selected.role==t?e.setRole(e.selected,"sketch"):e.setRole(e.selected,t)),a(t)}function a(e){for(let t in U)t==e?U[t].dom.classList.add("selected"):U[t].dom.classList.remove("selected")}function r(e){h.drawModeChanged.dispatch(e),o()}function o(){M.forEach(t=>{t.dom.classList.remove("selected"),t.dom.id==e.drawMode&&t.dom.classList.add("selected")})}function l(){"unit-scene"==e.currentScene.name?(u.setDisplay(""),b.setDisplay("none")):(u.setDisplay("none"),b.setDisplay(""))}let h=e.signals;var c=new UI.Panel;c.setId("toolbar");var u=new UI.Row;c.add(u);var d=(new UI.Button).setId("add-end").onClick(function(){"vp"==e.drawMode?(h.drawModeChanged.dispatch("normal"),d.dom.classList.remove("selected")):(h.drawModeChanged.dispatch("vp"),d.dom.classList.add("selected"))});d.dom.title="draw an end to initialize a skeleton curve",u.add(d);var p=(new UI.Button).setId("ca").onClick(t);p.dom.title="circle array",u.add(p);var m=(new UI.Row).setDisplay("none");u.add(m),m.add(new UI.Text("#").setClass("param").setWidth("10px"));var f=new UI.Integer(4).setRange(2,30).setWidth("30px").onChange(t);m.add(f);var g=(new UI.Button).setId("gca").onClick(function(){e.selected&&(e.unit.addTempleRibs(),e.select(null),i())});m.add(g);var w=(new UI.Button).setId("cca").onClick(s);m.add(w);(new UI.Button).setId("select-all");var v=(new UI.Button).setId("gen").onClick(function(){e.unit.generateShape()});u.add(v);var y=(new UI.Button).setId("clear").onClick(function(){e.unit.clearShapes()});u.add(y);var M=[],b=new UI.Row;c.add(b);var E=(new UI.Button).setId("line").onClick(function(){r(E.dom.id)});b.add(E);var x=(new UI.Button).setId("spline").onClick(function(){r(x.dom.id)});b.add(x),M.push(E,x);var R=(new UI.Button).setId("ellipse").onClick(function(){var t=new Sketch("Ellipse",[],[0,0,5,5,0,360,0,0]);e.addSketch(t)});b.add(R);var T=(new UI.Button).setId("sin").onClick(function(){var t=new Sketch("Sin",[],[1,1,0,0,360]);e.addSketch(t)});b.add(T);var C=(new UI.Button).setId("spiral").onClick(function(){var t=new Sketch("Spiral",[],[2,0,1,3]);e.addSketch(t)});b.add(C);var k=(new UI.Button).setId("torusKnot").onClick(function(){var t=new Sketch("TorusKnot",[],[5,2,2,3]);e.addSketch(t)});b.add(k);(new UI.Button).setId("decorativeKnot").onClick(function(){var t=new Sketch("DecoratedTorusKnot",[],[2,.6,5,.75,10,.35,5]);e.addSketch(t)});var I=(new UI.Row).setDisplay("none");b.add(I);var S=(new UI.Button).setId("set-axis").onClick(function(){n("axis")});I.add(S);var P=(new UI.Button).setId("set-reference").onClick(function(){n("reference")});I.add(P);var H=(new UI.Button).setId("make-axis").onClick(function(){n("contour")});let U={axis:S,reference:P,contour:H};return l(),h.drawModeChanged.add(function(e){"normal"==e&&d.dom.classList.remove("selected")}),h.objectSelected.add(function(t){t||e.unit.templeSkeleton.children.length>0&&s(),t instanceof Sketch?(I.setDisplay("inline"),a(t.role)):I.setDisplay("none")}),h.drawModeChanged.add(function(e){o()}),h.sceneChanged.add(function(){l()}),c};Unit.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:Unit,clone:function(){var e=new Unit;for(let t of this.skeleton.children)e.skeleton.add(t.clone());return this.sleeveRing&&(e.sleeveRing=this.sleeveRing.clone(),e.add(e.sleeveRing)),this.blades.children.length>0&&e.generateShape(),this.bearing&&this.buildBearing(),this.rod&&(e.rod=this.rod.clone(),e.add(e.rod)),this.fork&&(e.fork=this.fork.clone(),e.add(e.fork)),e.userData=JSON.parse(JSON.stringify(this.userData)),e.up.copy(this.up),e.position.copy(this.position),e.quaternion.copy(this.quaternion),e.scale.copy(this.scale),e.matrix.copy(this.matrix),e.matrixWorld.copy(this.matrixWorld),e.matrixAutoUpdate=this.matrixAutoUpdate,e.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate,e},dispose:function(){for(;this.skeleton.children.length>0;){let e=this.skeleton.children.pop();e.dispose()}this.clearShapes()},setMaterial:function(e){if("color"==e)return this.colorMaterial(),void(this.materialMode="color");this.currentMaterial=e,this.traverse(function(t){"unit-sleeve"!=t.name&&"unit-blade"!=t.name&&"unit-accessory"!=t.name&&"unit-rod"!=t.name&&"unit-fork"!=t.name||(t.material=e)})},colorMaterial:function(){this.sleeve&&(this.sleeve.material=sleeveColoredMaterial);for(let e of this.blades.children)e.material=bladeColoredMaterial;for(let e of this.accessories.children)e.material=accessoryColoredMaterial;this.rod&&this.rod.mechanism&&(this.rod.mechanism.material=rodColoredMaterial),this.fork&&this.fork.mechanism&&(this.fork.mechanism.material=forkColoredMaterial)},updatePointSize:function(e){if(e)for(rib of this.skeleton.children)rib.setPointSize(e);else for(rib of this.skeleton.children)rib.setPointSize(this.scale.z)},resetTransform:function(){this.rotation.set(0,0,0),this.scale.set(1,1,1),this.position.set(0,0,0)},addRib:function(e){let t=new THREE.BufferGeometry;t.addAttribute("position",new THREE.BufferAttribute(new Float32Array([0,0,0]),3));let s=new THREE.Points(t,new THREE.PointsMaterial({color:255}));s.name="ribpoint",s.layers.set(1),s.position.copy(e);let i=new Rib(s);i.initialize(),this.skeleton.add(i)},removeRib:function(e){this.skeleton.remove(e),e.dispose()},clearTemp:function(){for(rib of this.templeSkeleton.children)rib.dispose();this.templeSkeleton.children=[]},generateCircleArray:function(e,t){for(let i=1;i<t;i++){var s=e.clone();s.setColor(16772608),s.rotateZ(2*Math.PI/t*i),this.templeSkeleton.add(s)}},addTempleRibs:function(){for(;this.templeSkeleton.children.length>0;){let e=this.templeSkeleton.children[0],t=new THREE.Euler(0,0,-e.rotation.z);e.end.position.applyEuler(t),e.p1.position.applyEuler(t),e.p2.position.applyEuler(t),e.rotation.z=0,e.updateMatrix(),e.buildCurve(),e.setColor(255),this.skeleton.add(e)}},sortRibs:function(){this.skeleton.children=this.skeleton.children.sort(function(e,t){let s=e.p1.position.clone().applyMatrix4(e.endContainer.matrix).applyMatrix4(e.matrix),i=t.p1.position.clone().applyMatrix4(t.endContainer.matrix).applyMatrix4(t.matrix);var n=Math.atan2(s.y,s.x),a=Math.atan2(i.y,i.x);return n=n<0?n+2*Math.PI:n,a=a<0?a+2*Math.PI:a,n-a})},setMorphScale:function(e,t,s){for(let i of this.skeleton.children)i.setMorphScale(e,t,s),i.buildCurve();this.userData.morphTrans.size=[e,t,s]},resetMorphScale:function(){for(let e of this.skeleton.children)e.resetMorphScale(),e.buildCurve();this.userData.morphTrans.size=[1,1,1]},setMorphRotation:function(e,t,s){for(let i of this.skeleton.children)i.rotation.set(e,t,s),i.updateMatrix();this.userData.morphTrans.rotation=[e,t,s]},resetMorphRotation:function(){for(let e of this.skeleton.children)e.rotation.set(0,0,0),e.updateMatrix();this.userData.morphTrans.rotation=[0,0,0]},setMorphTranslation:function(e,t,s){for(let i of this.skeleton.children)i.setMorphTranslation(e,t,s),i.buildCurve();this.userData.morphTrans.bias=[e,t,s]},resetMorphTranslation:function(){for(let e of this.skeleton.children)e.resetMorphTranslation(),e.buildCurve();this.userData.morphTrans.bias=[0,0,0]},clearShapes:function(){for(blade of this.blades.children)blade.geometry.dispose();for(acc of(this.blades.children=[],this.accessories.children))acc.geometry.dispose();this.accessories.children=[],this.sleeve&&(this.traverse(function(e){e.geometry&&e.geometry.dispose()}),this.remove(this.sleeve),this.sleeve=null),this.polygon&&(this.polygon.geometry.dispose(),this.remove(this.polygon),this.polygon=null),this.bearing&&(this.bearing.geometry.dispose(),this.remove(this.bearing),this.bearing=null),this.sleeveRing&&(this.sleeveRing.geometry.dispose(),this.remove(this.sleeveRing),this.sleeveRing=null),this.rod&&(this.rod.dispose(),this.remove(this.rod),this.rod=null),this.fork&&(this.fork.dispose(),this.remove(this.fork),this.fork=null)},generateShape:function(){this.clearShapes(),"propeller"==this.shape?(this.buildSleeve(),this.buildBlades(),this.buildAccessories()):"polygon"==this.shape&&(this.buildSleeve(),this.buildPolygon())},buildPolygon:function(){this.polygon&&(this.traverse(function(e){e.geometry&&e.geometry.dispose()}),this.remove(this.polygon),this.polygon=null),this.sortRibs();let e=[];for(let t of this.skeleton.children){let s=new THREE.Vector3;t.end.localToWorld(s),e.push(s)}let t=new THREE.Shape;t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)t.lineTo(e[s].x,e[s].y);t.lineTo(e[0].x,e[0].y);let s=new THREE.Shape;s.arc(0,0,this.userData.sleeve.rOut),t.holes.push(s);let i={steps:1,depth:.5,bevelEnabled:!1},n=new THREE.ExtrudeBufferGeometry(t,i);n.translate(0,0,-.25),this.polygon=new THREE.Mesh(n,this.currentMaterial),this.add(this.polygon)},buildSleeve:function(){this.sleeve&&(this.traverse(function(e){e.geometry&&e.geometry.dispose()}),this.remove(this.sleeve),this.sleeve=null);let e=this.userData.sleeve.rOut,t=this.userData.sleeve.rInner,s=this.userData.sleeve.thickness,i=new THREE.Shape;i.arc(0,0,1.01*e);let n=new THREE.Shape;n.arc(0,0,t),i.holes.push(n);let a={steps:1,depth:s,bevelEnabled:!1},r=new THREE.ExtrudeBufferGeometry(i,a);r.translate(0,0,-s/2),this.sleeve=new THREE.Mesh(r,this.currentMaterial),this.sleeve.name="unit-sleeve",this.sleeve.layers.set(4),this.add(this.sleeve),this.sleeveRing||this.buildSleeveRing()},buildSleeveRing:function(){this.sleeveRing&&(this.sleeveRing.geometry.dispose(),this.remove(this.sleeveRing));let e=this.userData.sleeve.rOut,t=new THREE.EllipseCurve(0,0,e,e);var s=t.getPoints(72),i=(new THREE.BufferGeometry).setFromPoints(s);this.sleeveRing=new THREE.Line(i,sleeveRingMaterial),this.sleeveRing.layers.set(3),this.add(this.sleeveRing)},buildBlades:function(){for(blade of this.blades.children)blade.geometry.dispose();this.blades.children=[];for(let t of this.skeleton.children){t.curve||t.initialize();let s=new THREE.Shape;"ellipse"==t.sectionShape&&s.ellipse(0,0,t.sectionShapeParams.a,t.sectionShapeParams.b);let i=t.sweepSteps,n=0;var e=t.curve.getSpacedPoints(i);for(let t=1;t<=i;t++)if(e[t].distanceTo(new THREE.Vector3)>=this.userData.sleeve.rInner){n=t;break}let a=[];for(let e=0;e<t.widths.length;e++)a.push(new THREE.Vector2(t.widths[e][1],t.thicknesses[e][1]));let r={curveSegments:8,steps:i,depth:1,sweepPath:t.curve,bevelEnabled:!1,scales:a,twists:t.twists.map(function(e){return e[1]/180*Math.PI}),clipping:n},o=new THREE.Mesh(new SweepBufferGeometry(s,r),this.currentMaterial);o.applyMatrix(t.matrix),o.applyMatrix(this.skeleton.matrix),o.layers.set(4),o.name="unit-blade",this.blades.add(o)}},buildAccessories:function(){for(acc of this.accessories.children)acc.geometry.dispose();this.accessories.children=[];for(let e of this.skeleton.children)for(let t of e.markerContainer.children){let s=t.pos,i=t.sca,n=t.shape,a=new THREE.Mesh(buildAccessoryGeometry(n),this.currentMaterial);a.scale.set(i,i,i),a.layers.set(4),a.name="unit-accessory",a.position.copy(t.position.clone().applyMatrix4(e.matrix));let r=e.getTNB(s),o=Math.atan2(r.y,r.x);a.rotateZ(o+Math.PI),this.accessories.add(a)}},buildBearing:function(e=.2){this.bearing&&(this.bearing.geometry.dispose(),this.remove(this.bearing),this.bearing=null);let t=1.1*this.userData.sleeve.rInner,s=1.2*this.userData.sleeve.thickness,i=new THREE.Shape;i.arc(0,0,t);let n=new THREE.Shape;n.arc(0,0,e),i.holes.push(n);let a={steps:1,depth:s,bevelEnabled:!1},r=new THREE.ExtrudeGeometry(i,a);r.translate(0,0,-s/2),this.bearing=new THREE.Mesh(r,bearingMaterial),this.bearing.name="unit-bearing",this.bearing.layers.set(4),this.add(this.bearing)},computeBestPhase:function(){let e=[];for(let t of this.skeleton.children){let s=t.getInstallAngle(this.userData.sleeve.rInner);s=s<0?s+2*Math.PI:s,e.push(s)}e=e.sort(function(e,t){return e-t});let t=0,s=0;for(let i=0;i<e.length-1;i++){let n=e[i+1]-e[i];n>t&&(t=n,s=i)}let i=2*Math.PI-e[e.length-1]+e[0];i>t&&(t=i,s=e.length-1),this.junctionPhase=e[s]+t/2},buildRod:function(e=Math.PI/3,t){this.clearRod();let s=this.userData.sleeve.rOut;t=t||2*s,this.rod=new Junction("Rod",e,t,this.junctionPhase,s),this.add(this.rod),this.rod.updateMatrixWorld()},clearRod:function(){this.rod&&(this.rod.dispose(),this.remove(this.rod),this.rod=null)},buildFork:function(e=Math.PI/3,t){this.clearFork();let s=this.userData.sleeve.rOut;t=t||2*s,this.fork=new Junction("Fork",e,t,this.junctionPhase,s),this.add(this.fork),this.fork.updateMatrixWorld()},clearFork:function(){this.fork&&(this.fork.dispose(),this.remove(this.fork),this.fork=null)},getMaxRadius:function(){let e=0;for(let t of this.skeleton.children){let s=t.getServoCylindrical(t.end).r;e=s>e?s:e}return e},getMechanisms:function(){let e=[];return this.sleeve&&e.push(this.sleeve),this.blades&&e.push(this.blades),this.accessories&&e.push(this.accessories),e},refineSleeve:function(){let e=1.5*this.userData.sleeve.rOut,t=1.5*this.userData.sleeve.thickness,s=new THREE.Mesh(new THREE.CylinderGeometry(e,e,t,32,1));s.rotateX(Math.PI/2),s.updateMatrix(),this.add(s);let i=CSG.fromMesh(s),n=1.3*this.userData.sleeve.rInner,a=new THREE.Mesh(new THREE.CylinderGeometry(.8*n,.8*n,t,32,1)),r=new THREE.Mesh(new THREE.CylinderGeometry(n,n,.8*t,32,1));a.rotateX(Math.PI/2),r.rotateX(Math.PI/2),r.translateY(.2*t),a.updateMatrix(),r.updateMatrix(),this.add(a),this.add(r);let o=CSG.fromMesh(a),l=CSG.fromMesh(r);i=i.subtract(o).subtract(l);let h=new THREE.Group;this.add(h);for(let t of this.skeleton.children){let s=t.getInstallAngle(n),a=new THREE.Mesh(new THREE.CylinderGeometry(.15,.15,e,32));a.rotateZ(s-Math.PI/2),a.translateY(e/2+n+.1),h.add(a),a.updateMatrixWorld();let r=CSG.fromMesh(a);i=i.subtract(r)}if(this.rod){let e=this.rod.plug.clone();e.applyMatrix(this.rod.matrix);let t=CSG.fromMesh(e);i=i.subtract(t)}if(this.fork){let e=this.fork.plug.clone();e.applyMatrix(this.fork.matrix);let t=CSG.fromMesh(e);i=i.subtract(t)}let c=CSG.toMesh(i,s.matrix);for(rib of(this.remove(s,a,r),s.geometry.dispose(),a.geometry.dispose(),r.geometry.dispose(),this.remove(h),h.children))rib.geometry.dispose();return c},toJSON:function(){return{type:"Unit",userData:this.userData,matrix:this.matrix.toArray(),ribs:this.skeleton.children.map(function(e){return e.toJSON()}),generated:this.blades.children.length>0,metaRotation:this.metaRotation.toArray()}},fromJSON:function(e){this.userData=e.userData;for(let s of e.ribs){var t=new Rib;t.fromJSON(s),this.skeleton.add(t)}return e.generated&&this.generateShape(),this.applyMatrix((new THREE.Matrix4).fromArray(e.matrix)),this.metaRotation=(new THREE.Euler).fromArray(e.metaRotation),this.updatePointSize(),this}});var Viewport=function(e){function t(){"unit-scene"==k.name?H=e.unit.skeleton.children:"sculpture-scene"==k.name&&(H=[],H.push(...e.sketches),e.sculpture.units.children.length>0&&H.push(...e.sculpture.getMechanisms()))}function s(t){"Shift"==t.key&&(x=!0,e.selectedObjects.indexOf(e.selected)<0&&e.selectedObjects.push(e.selected),window.addEventListener("keyup",i,!1))}function i(e){"Shift"==e.key&&(x=!1)}function n(e,t,s){var i=e.getBoundingClientRect();return[(t-i.left)/i.width,(s-i.top)/i.height]}function a(e){return G.set(2*e.x-1,-2*e.y+1),z.setFromCamera(G,S),z.intersectObject(P)[0].point}function r(t){t.preventDefault();var s=n(R.dom,t.clientX,t.clientY);N.fromArray(s),2==t.button?(U&&g(),M.drawModeChanged.dispatch("normal")):"brush2d"!=e.drawMode&&"brush3d"!=e.drawMode||d(e.drawMode),document.addEventListener("mouseup",o,!1)}function o(e){var t=n(R.dom,e.clientX,e.clientY);W.fromArray(t),c(e),document.removeEventListener("mouseup",o,!1)}function l(t){t.preventDefault();var s=n(R.dom,t.clientX,t.clientY);if(J.fromArray(s),U)switch(e.drawMode){case"line":case"spline":m(U.name),h(a(J));break;case"brush2d":case"brush3d":f(),h(a(J))}}function h(t){if(U&&!(U.keyPoints.length<4))if(t.distanceTo(U.keyPoints[0])<1)switch(e.drawMode){case"line":case"spline":1==U.pointMeshes[0].scale.x&&(U.pointMeshes[0].scale.set(2,2,2),D=!0);break;case"brush2d":case"brush3d":U.closed=!0,g()}else switch(e.drawMode){case"line":case"spline":2==U.pointMeshes[0].scale.x&&U.pointMeshes[0].scale.set(1,1,1),D=!1}}function c(t){switch(e.drawMode){case"line":case"spline":d(e.drawMode);break;case"brush2d":case"brush3d":g();break;case"vp":return void e.unit.addRib(a(W))}if(2==t.button)return;if(N.distanceTo(W)>.01)return;let s=null;var i=u(W,H);if(0!=i.length){for(let e of i){let t=e.object;if("unit-sleeve"==t.name||"unit-bearing"==t.name){s=t.parent;break}if("unit-blade"==t.name||"unit-accessory"==t.name){s=t.parent.parent;break}if(t instanceof THREE.Points){s=t;break}}s||("sketch line"==i[0].object.name?s=i[0].object.parent:"ribcurve"==i[0].object.name&&(s=i[0].object.parent.parent)),x?e.select(s,!0):e.select(s)}else e.select(null)}function u(e,t){return G.set(2*e.x-1,-2*e.y+1),z.setFromCamera(G,S),z.intersectObjects(t,!0)}function d(e){if(U)switch(e){case"line":case"spline":f();break;case"brush2d":case"brush3d":g()}else p(e)}function p(e){var t=a("brush2d"==e||"brush3d"==e?N:W),s=(new THREE.Vector3).copy(t);U=new Sketch(e,[t,s]),k.add(U),R.dom.addEventListener("mousemove",l,!1)}function m(){U.keyPoints[U.keyPoints.length-1]=a(J),U.buildMesh()}function f(){U.keyPoints.push(a(J)),U.buildMesh(),D&&(U.closed=!0,"spline"==U.name?U.keyPoints.pop():"line"==U.name&&U.keyPoints[U.keyPoints.length-2].copy(U.keyPoints[0]),U.buildMesh(),g())}function g(){switch(e.addSketch(U),D=!1,e.drawMode){case"line":case"spline":w();break;case"brush2d":case"brush3d":U.reduce(),U=null}R.dom.removeEventListener("mousemove",l,!1)}function w(){U.keyPoints.pop(),U.keyPoints.length<=1?k.remove(U):U.buildMesh(),U=null}function v(){requestAnimationFrame(v),y(),K.update(),e.isPlay&&e.sculpture.simulateMotion(),C.update()}function y(){I.updateMatrixWorld(),k.updateMatrixWorld(),T.render(k,S),T.render(I,S)}var M=e.signals;let b={T:"bias",R:"rotation",S:"size"},E={bias:"translate",rotation:"rotate",size:"scale"};var x=!1,R=new UI.Panel;R.setId("viewport");var T=new THREE.WebGLRenderer({antialias:!0});T.autoClear=!1,T.autoUpdateScene=!1,T.setPixelRatio(window.devicePixelRatio),T.setSize(R.dom.offsetWidth,R.dom.offsetHeight),T.setClearColor(16777215),R.dom.appendChild(T.domElement);var C=new Stats;C.dom.style.top="54px",C.dom.style.left="184px";var k=e.currentScene,I=e.sceneHelpers,S=e.camera,P=e.unitCanvas,H=[],U=null,D=!1,V=null,O=null,L=null,A=!1,j=new THREE.MorphControls(S,R.dom);j.setSpace("local"),j.setMode("scale"),j.addEventListener("change",function(){A&&(M.unitMorphed.dispatch(j.object),y())}),I.add(j),j.addEventListener("mouseDown",function(){A=!0,K.enabled=!1}),j.addEventListener("mouseUp",function(){A=!1,K.enabled=!0});var B=new THREE.TransformControls(S,R.dom);B.setSpace("local"),B.addEventListener("change",function(){var e=B.object;if(void 0!==e){if("translate"==B.getMode()&&"control point"==e.name){let t=e.parent,s=t.pointMeshes.indexOf(e);t.keyPoints[s]=e.position,t.buildMesh()}if("translate"==B.getMode()&&"ribpoint"==e.name){let t=e.parent.parent;null!=t.curve&&t.buildCurve()}M.objectTransformed.dispatch(e),y()}}),B.addEventListener("mouseDown",function(){var e=B.object;V=e.position.clone(),O=e.rotation.clone(),L=e.scale.clone(),K.enabled=!1}),B.addEventListener("mouseUp",function(){var e=B.object;if(void 0!==e)switch(B.getMode()){case"translate":V.equals(e.position)||(V=e.position);break;case"rotate":O.equals(e.rotation)||(O=e.rotation);break;case"scale":L.equals(e.scale)||(L=e.scale)}K.enabled=!0}),I.add(B),window.addEventListener("keydown",s,!1);var z=new THREE.Raycaster,G=new THREE.Vector2,N=new THREE.Vector2,W=new THREE.Vector2,J=new THREE.Vector2;R.dom.addEventListener("mousedown",r,!1);var K=new THREE.TrackballControls(S,R.dom);return K.zoomSpeed=1.2,K.panSpeed=.5,K.rotateSpeed=1,K.staticMoving=!0,K.dynamicDampingFactor=.3,M.drawModeChanged.add(function(t){if(U=null,e.drawMode==t)return e.drawMode="normal",void(K.enabled=!0);switch(e.drawMode=t,e.drawMode){case"normal":K.enabled=!0,R.setCursor("default");break;case"vp":case"line":case"spline":case"brush2d":case"brush3d":K.enabled=!1,R.setCursor("crosshair")}}),M.windowResize.add(function(){S.aspect=R.dom.offsetWidth/R.dom.offsetHeight,S.updateProjectionMatrix(),K.handleResize(),T.setSize(R.dom.offsetWidth,R.dom.offsetHeight),y()}),M.objectSelected.add(function(t){if(null==t)return B.detach(),void j.detach();if(t instanceof Unit){B.detach();let s=b[e.currentMorph];e.unitMorphKeys[s].indexOf(t)>=0?(j.attach(t),j.setMode(E[s])):j.detach()}else B.attach(t),t instanceof Sketch?M.transformModeChanged.dispatch("rotate"):t instanceof Rib?M.transformModeChanged.dispatch("rotate"):("ribpoint"==t.name||t.name,M.transformModeChanged.dispatch("translate"))}),M.sculptureChanged.add(t),M.transformModeChanged.add(function(e){B.setMode(e)}),M.setMorphControl.add(function(t){if(e.selected instanceof Unit)switch(j.attach(e.selected),t){case"bias":j.setMode("translate");break;case"rotation":j.setMode("rotate");break;case"size":j.setMode("scale")}}),M.removeMorphControl.add(function(){j.detach()}),M.worldTransform.add(function(e){e?B.setSpace("world"):B.setSpace("local")}),M.sceneChanged.add(function(s){k=e.currentScene,t(),P="unit-scene"==s?e.unitCanvas:e.sketchCanvas,e.deselect(),K.reset()}),M.sceneCleared.add(function(){k=e.currentScene}),M.sketchChanged.add(function(){t()}),v(),R};const lineModes={gl:"gl",tube:"tube"};var lineMode="tube";const lineWidths={sketch:2,axis:3},lineColors={selected:16755200,axis:16711680,reference:65280,sketch:255,contour:12632256},timeOrderColors={0:12632256,1:16750487,2:14267136,3:12320699,4:7321527};var leafGeometry=null;(function(){let e=new THREE.Shape;e.ellipse(0,0,.5,.5);let t=new THREE.CatmullRomCurve3([new THREE.Vector3(1,-2,0),new THREE.Vector3(.5,-1.4,0),new THREE.Vector3(0,0,0),new THREE.Vector3(.5,1.4,0),new THREE.Vector3(1,2,0)]),s={curveSegments:8,steps:8,depth:1,sweepPath:t,bevelEnabled:!1,
scales:[new THREE.Vector2(0,0),new THREE.Vector2(.3,.1),new THREE.Vector2(.6,.15),new THREE.Vector2(.85,.2),new THREE.Vector2(1,.25),new THREE.Vector2(.85,.2),new THREE.Vector2(.6,.15),new THREE.Vector2(.3,.1),new THREE.Vector2(0,0)],twists:[0,0,0,0,0,0,0,0,0]};leafGeometry=new SweepBufferGeometry(e,s)})();var bowlGeometry=null;(function(){let e=new THREE.Shape;e.ellipse(0,.5,1,.5,-Math.PI/2,0),e.lineTo(.9,.5),e.ellipse(-.9,0,.9,.4,0,-Math.PI/2,!0),bowlGeometry=new THREE.LatheGeometry(e.extractPoints(16).shape,16)})();var ringGeometry=null;(function(){let e=new THREE.Shape;e.arc(0,0,1);let t=new THREE.Shape;t.arc(0,0,.6),e.holes.push(t);let s={steps:1,depth:.1,bevelEnabled:!1};ringGeometry=new THREE.ExtrudeGeometry(e,s),ringGeometry.translate(0,0,-.05),ringGeometry.rotateX(Math.PI/2)})();var exporter=new THREE.STLExporter;let morphOpMap={bias:"setMorphTranslation",rotation:"setMorphRotation",size:"setMorphScale"};var cubemapLoader=new THREE.CubeTextureLoader;const pureColor=new THREE.Color(16777215);pureColor.name="none";const bridgeTexture=loadCubeMap("scene1"),skyTexture=loadCubeMap("scene2"),backgrounds={none:pureColor,scene1:bridgeTexture,scene2:skyTexture};var markerMaterial=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load("resource/marker.png")});const sleeveRingMaterial=new THREE.LineBasicMaterial({color:0}),rodHelperMaterial=new THREE.LineBasicMaterial({color:16733440}),forkHelperMaterial=new THREE.LineBasicMaterial({color:61098}),junctionHelperMaterials={Rod:rodHelperMaterial,Fork:forkHelperMaterial},rodFrustumMaterial=new THREE.MeshStandardMaterial({color:16733440,roughness:1,metalness:0,side:THREE.DoubleSide,transparent:!0,opacity:.6}),forkFrustumMaterial=new THREE.MeshStandardMaterial({color:61098,roughness:1,metalness:0,side:THREE.DoubleSide,transparent:!0,opacity:.6}),axleMaterial=new THREE.MeshStandardMaterial({color:4210752,roughness:1,metalness:0}),bearingMaterial=new THREE.MeshStandardMaterial({color:16119285,roughness:1,metalness:0}),sleeveColoredMaterial=new THREE.MeshStandardMaterial({color:2189006,roughness:1,metalness:.3}),bladeColoredMaterial=new THREE.MeshStandardMaterial({color:4737096,emissive:4605510,roughness:1,metalness:.3}),accessoryColoredMaterial=new THREE.MeshStandardMaterial({color:413458,roughness:1,metalness:0}),rodColoredMaterial=new THREE.MeshStandardMaterial({color:16733440,roughness:1,metalness:.3}),forkColoredMaterial=new THREE.MeshStandardMaterial({color:34901,roughness:1,metalness:.3}),grayMaterial=new THREE.MeshStandardMaterial({color:4737096,emissive:4605510,roughness:1,metalness:0});grayMaterial.name="gray";var metalMaterial=new THREE.MeshStandardMaterial({color:16777215,roughness:0,metalness:1,envMap:skyTexture});metalMaterial.name="metal";const selectedMaterial=new THREE.MeshStandardMaterial({color:16776960,roughness:1,metalness:0});var labeledMaterial=selectedMaterial.clone();const highlightUnitMaterial=new THREE.MeshStandardMaterial({color:16711680,roughness:1,metalness:0});class prototypeSolver{constructor(e=[],t=null,s=20,i=new Unit,n=new KineticSculpture){this.givenAxis=!!t,this.Axisclosed=!1,this.axisVariation="shape",this.perpendicularSkeleton=!0,this.maxIter=1e4,this.optMethod="SA",this.radialSegments=36,this.n=s,this.unit=i,this.sculpture=n,this.sketches=e,this.axis=t,this.axisPoints2D=[],this.axisPlaneNormalRotation=new THREE.Euler(0,0,0),this.junctionEnvelopeHeights=[],this.junctionRodPhases=[];for(let e=0;e<this.n-1;e++)this.junctionEnvelopeHeights.push(.6),this.junctionRodPhases.push(0);this.axisPoints=[],this.axisPlane=new THREE.Plane(this.axisPlaneNormal,0),this.S=[],this.sculptures=[],this.E_dissimilarity=1/0,this.E_connection=1/0,this.E_collision=1/0,this.E_axis=1/0,this.energy=1/0,this.computeEnergy(),this.discreteSketches=[]}getSketchesInfo(){let e=[];for(let t of this.sketches)t.map(function(t){e.push(...t.curve.getSpacedPoints(200))});this.sketchBox=(new THREE.Box3).setFromPoints(e),this.sketchSphere=(new THREE.Sphere).setFromPoints(e)}initializeAxis(e=!1){this.getSketchesInfo(),this.axis?this.setAxis(axis):(this.givenAxis=!1,this.axisClosed=e,this.generateAxis(!0)),this.searchJunctionEnvelopes()}setAxis(e){this.givenAxis=!0,this.axis=e,this.sculpture.axis=e}searchJunctionEnvelopes(){return this.sculpture.setSleeveRadii(),this.axis.sample(this.n),this.sculpture.layout(this.unit,{n:this.n,scale:1,torsion:0},!0),this.sculpture.buildJoints()}searchAxisByJuncEnv(){let e=!1;for(;!e;)this.generateAxis(!1),e=this.searchJunctionEnvelopes()}initializeUnitEnvelopes(){let e=new Unit;this.sculpture=new KineticSculpture(this.axis),this.sculpture.unit=e,this.axis.sample(this.n),this.sculpture.layout(this.axis.samplingPoints);for(let e=0;e<this.n;e++){let t=this.sculpture.units.children[e],s=-100,i=100,n=0,a=this.axis.samplingNormalPlanes[e];for(let e of this.sketches)for(let r of e)for(let e of r.denseLines){let r=new THREE.Vector3,o=a.intersectLine(e,r);if(null!=o){let e=t.worldToLocal(r);s=e.z>s?e.z:s,i=e.z<i?e.z:i;let a=Math.sqrt(e.x**2+e.y**2);n=a>n?a:n}}t.buildEnvelope(n,s,i)}}generateAxis(e=!1){this.givenAxis||(this.axis&&this.axis.dispose(),this.axisPoints2D=[],this.axisPoints=[],this.axisClosed?this.axis=this.buildClosedAxis(e):this.axis=this.buildOpenAxis(e),this.sculpture.axis=this.axis)}buildOpenAxis(e=!1){let t=0,s=.05,i=this.sketchBox,n=i.min,a=i.max,r=n.x-(a.x-n.x)*t,o=a.x+(a.x-n.x)*t,l=n.y-(a.y-n.y)*s,h=a.y+(a.y-n.y)*s,c=o-r,u=h-l,d=Math.min(c,u)/10;if(e)for(let e=0;e<6;e++)this.axisPoints2D.push(new THREE.Vector3(r+c/2,l+u/5*e,0)),this.axisPoints.push(new THREE.Vector3(r+c/2,l+u/5*e,0));else for(this.generateOpenAxisControlPoints(r,o,l,h,c,u);this.checkBadAxis(d);)this.generateOpenAxisControlPoints(r,o,l,h,c,u);return new Sketch("spline",this.axisPoints,void 0,"axis",!1)}generateOpenAxisControlPoints(e,t,s,i,n,a){let r=sample(e,t,6),o=sample(s,i,4);o.sort(),o.unshift(s),o.push(i);for(let e=0;e<6;e++)this.axisPoints2D.push(new THREE.Vector3(r[e],o[e],0));this.mapPointsOnPlane()}mapPointsOnPlane(){let e=new THREE.Vector3(0,0,1);this.axisPlaneNormalRotation=new THREE.Euler((1-2*Math.random())*Math.PI/6,(1-2*Math.random())*Math.PI/6,0),e.applyEuler(this.axisPlaneNormalRotation),this.axisPlane.set(e,0),this.axisPoints=pointsToPlane(this.axisPoints2D,this.axisPlane)}buildClosedAxis(e=!1){let t=this.sketchSphere.radius,s=this.sketchSphere.center;if(e){let e=.8*t;for(let t=0;t<6;t++){let i=s.x+e*Math.cos(Math.PI/3*t),n=s.y+e*Math.sin(Math.PI/3*t),a=new THREE.Vector3(i,n,0);this.axisPoints2D.push(a),this.axisPoints.push(a.clone())}}else for(let e=0;e<6;e++){let i=(.4*Math.random()+.6)*t,n=s.x+i*Math.cos(Math.PI/3*(e+Math.random()-.5)),a=s.y+i*Math.sin(Math.PI/3*(e+Math.random()-.5)),r=new THREE.Vector3(n,a,0);this.axisPoints2D.push(r),this.mapPointsOnPlane()}return new Sketch("spline",this.axisPoints,void 0,"axis",!0)}checkBadAxis(e=0,t=Math.PI/4){for(let s=1;s<6;s++){let i=this.axisPoints[s],n=this.axisPoints[s-1];if(i.distanceTo(n)<e)return!0;if(s>1){let e=this.axisPoints[s-2],a=(new THREE.Vector3).subVectors(i,n),r=(new THREE.Vector3).subVectors(n,e);if(a.angleTo(r)>=t)return!0}}}searchFeasibleJunctionEnvelopes(){for(this.generateJunctionEnevelopes();!this.checkJunctionEnvelopes();)this.generateJunctionEnevelopes()}generateJunctionEnevelopes(){for(let e=0;e<this.n-1;e++){let t=this.sculpture.units.children[e],s=this.sculpture.units.children[e+1];if(t.isEmpty||s.isEmpty)continue;this.junctionEnvelopeHeights[e]=.6+.3*Math.random();let i=t.position.distanceTo(s.position)*this.junctionEnvelopeHeights[e],n=i+this.r0,a=new Junction("Rod",this.r0,n,i,this.radialSegments);t.rod=a,t.transmissions.add(a);let r=new Junction("Fork",this.r0,n,i,this.radialSegments);s.fork=r,s.transmissions.add(r)}}checkJunctionEnvelopes(){for(let e=0;e<this.n-1;e++){let t=this.sculpture.units.children[e],s=this.sculpture.units.children[e+1];if(t.isEmpty||s.isEmpty)continue;let i=t.rod.envelope,n=s.fork.envelope,a=i.geometry.vertices.length/2,r=-1;for(let e=0;e<a;e++){if(generatrixIntersection(i,n,.95,a,e))this.E_connection=0;else if(-1==r)r=e;else if(r==e-1)return this.E_connection=1/0,!1;if(generatrixIntersection(i,this.axis,1.05,a,e)||generatrixIntersection(n,this.axis,1.05,a,e))return this.E_collision=1/0,!1;this.E_collision=0}}return!0}computeJunctionEnvelopeFeasibility(){for(let e=0;e<this.n-1;e++){let t=this.sculpture.units.children[e],s=this.sculpture.units.children[e+1];t.isEmpty||s.isEmpty||this.collideJunctions(t.rod.envelope,s.fork.envelope)}}initializeJunctionPhases(){for(let e=0;e<this.n-1;e++){let t=this.sculpture.units.children[e],s=this.sculpture.units.children[e+1];!t.isEmpty&&s.isEmpty}}initializeSculpture(){this.sculpture=new KineticSculpture(this.axis,this.sketches[0]),this.sculpture.buildSkeleton(10,this.n)}getObjectiveContours(){0==this.axis.samplingPoints.length&&this.axis.sample(this.n),this.discreteSketches=[];for(let e=0;e<this.sketches.length;e++){let t=this.sketches[e],s=[];for(let e=0;e<this.n;e++){let i=this.axis.samplingNormalPlanes[e],n=[];for(let e of t)for(let t of e.denseLines){let e=new THREE.Vector3,s=i.intersectLine(t,e);null==s||n.push(e)}s.push(n)}this.discreteSketches.push(s)}}initializeSkeleton(){this.axis.samplingTangents(this.n);for(let t=0;t<this.n;t++){let s=[],i=this.axis.samplingNormalPlanes[t],n=new THREE.Vector3;var e=[];for(let s of this.sketches[t])for(let t of s.denseLines)e.push(t.clone());for(let t of e)i.intersectsLine(t)&&s.push(i.intersectLine(t,n));this.axis.samplingPoints[t];for(let e of s);}}buildSkeletons(){for(let e of this.sketches){let t=this.axis.clone(),s=new KineticSculpture(t,e);s.buildSkeleton(10,this.n),this.sculptures.push(s)}}searchSkeletons(){this.getDissimilarity()}searchJunctions(){}computeMotion(){}computeEnergy(){this.energy=this.E_connection+this.E_collision+this.E_dissimilarity+this.E_axis}computeShapeEnergy(){for(let e of this.discreteSketches)this.E_dissimilarity+=this.getDissimilarity(e)}getDissimilarity(e){let t=0;for(let s=0;s<this.n;s++){if(0==e[s].length)continue;let i=this.sculpture.units.children[s],n=i.skeleton.children.map(function(e){let t=i.localToWorld(e.end.position.clone());return t.z=0,t});for(let i of n){let n=100;for(let t of e[s]){let e=i.distanceTo(t);n=e<n?e:n}t+=n}}return t}computeAxisEnergy(){this.E_axis=getCurvatureData(this.axis.curve,200).curvature.max}computeCollisions(){for(let e=0;e<this.n-1;e++){let t=this.sculpture.units.children[e],s=this.sculpture.units.children[e+1];null!=t.rod&&null!=s.fork&&(this.collideJunctions(t.rod.envelope,s.fork.envelope),this.collideSkeletons(t,s))}}collideJunctions(e,t){let s=e.geometry.vertices.length/2,i=-1;for(let n=0;n<s;n++){if(generatrixIntersection(e,t,.95,s,n))this.E_connection=0;else if(-1==i)i=n;else if(i==n-1)return console.log("junction separated"),void(this.E_connection=1/0);if(generatrixIntersection(e,this.axis,1.05,s,n)||generatrixIntersection(t,this.axis,1.05,s,n))return void(this.E_collision=1/0);if(this.E_collision=0,generatrixIntersection(e,t.parent.parent.parent.parent.skeleton,1.05,s,n)||generatrixIntersection(t,e.parent.parent.parent.parent.skeleton,1.05,s,n))return void(this.E_collision=1/0);this.E_collision=0}}collideSkeletons(e,t){let s=e.colliders.children[0],i=t.colliders.children[0],n=s.geometry.vertices.length/2-1;for(let e=0;e<n;e++){if(generatrixIntersection(s,i,1,n,e))return void(this.E_collision=1/0);if(generatrixIntersection(s,this.axis,1,n,e)||generatrixIntersection(i,this.axis,1,n,e))return void(this.E_collision=1/0)}}searchPhase(){}solve(e="SA"){this.getSketchesInfo(),this.initializeAxis()}}